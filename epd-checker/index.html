<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project asfalt LCA – InfraImpact</title>
  <meta name="description" content="Stel snel een project-specifieke asfalt LCA op aan de hand van enkele projectinputs, asfaltcentrales en mengseldata. Inclusief EPD-parsing voor MKI en GWP.">

  <!-- Favicons & App Icons (paden indien nodig aanpassen) -->
  <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon.png">
  <link rel="icon" type="image/webp" sizes="32x32" href="../assets/favicon.webp">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
  <meta name="theme-color" content="#2F3B52">

  <style>
    :root {
      --ii-bg: #f5f7fa;
      --ii-primary: #1c4f82;
      --ii-primary-dark: #153b60;
      --ii-accent: #00a676;
      --ii-text: #1f2933;
      --ii-border: #d0d7e2;
      --ii-radius: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--ii-bg);
      color: var(--ii-text);
    }

    header {
      background: white;
      border-bottom: 1px solid var(--ii-border);
    }

    .header-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--ii-primary-dark);
      text-decoration: none;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    nav a {
      text-decoration: none;
      color: var(--ii-text);
      font-size: 0.95rem;
    }

    nav a.active {
      color: var(--ii-primary);
      font-weight: 600;
    }

    main {
      max-width: 1080px;
      margin: 24px auto 40px;
      padding: 0 16px 40px;
    }

    h1.page-title {
      margin: 0 0 8px;
      font-size: 1.8rem;
      color: var(--ii-primary-dark);
    }

    p.page-subtitle {
      margin: 0 0 20px;
      max-width: 720px;
      color: #4b5563;
      font-size: 0.96rem;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 20px;
    }

    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #ffffff;
      border-radius: var(--ii-radius);
      border: 1px solid var(--ii-border);
      padding: 16px 16px 18px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
      margin-bottom: 18px;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 1.1rem;
      color: var(--ii-primary-dark);
    }

    .card h3 {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 0.98rem;
      color: var(--ii-primary-dark);
    }

    .card p.lead {
      margin: 0 0 12px;
      font-size: 0.88rem;
      color: #6b7280;
    }

    .field-group { margin-bottom: 10px; }

    .field-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #4b5563;
    }

    input[type="text"],
    input[type="number"],
    select {
      border-radius: 6px;
      border: 1px solid var(--ii-border);
      padding: 7px 9px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #ffffff;
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--ii-primary);
      box-shadow: 0 0 0 1px rgba(28,79,130,0.08);
    }

    small {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--ii-primary);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--ii-primary-dark);
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--ii-primary-dark);
      border: 1px solid var(--ii-border);
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .list {
      border-radius: 8px;
      border: 1px dashed var(--ii-border);
      padding: 8px;
      background: #f9fafb;
      max-height: 260px;
      overflow-y: auto;
    }

    .list-item {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--ii-border);
      padding: 7px 9px;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.8rem;
    }

    .list-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .list-title {
      font-weight: 600;
      color: var(--ii-primary-dark);
    }

    .list-sub {
      color: #6b7280;
      font-size: 0.78rem;
    }

    .muted {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    footer {
      border-top: 1px solid var(--ii-border);
      padding: 14px 16px 18px;
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      background: #ffffff;
    }
  </style>
</head>
<body>
  <!-- Vervang deze header desgewenst door de exacte header van je site -->
  <header>
    <div class="header-inner">
      <a class="logo" href="../index.html">InfraImpact</a>
      <nav>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li><a href="../projecten.html">Projecten</a></li>
          <li><a href="../epd-checker/">MKI-toetsing asfalt</a></li>
          <li><a href="./index.html" class="active">Project asfalt LCA</a></li>
          <li><a href="../contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <h1 class="page-title">Project asfalt LCA</h1>
    <p class="page-subtitle">
      Voer projectgegevens, asfaltcentrales en mengseldata in. Upload EPD’s om automatisch MKI (A1–A3 + D) 
      en CO₂ (GWP A1–A3 + D) uit te lezen. Exporteer alles als CSV en PDF voor je LCA-dossier.
    </p>

    <div class="grid">
      <div>
        <!-- Project / rapport -->
        <section class="card">
          <h2>LCA Rapport Invoeren</h2>
          <p class="lead">Basisgegevens van het rapport, vergelijkbaar met je LCApro-tool.</p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="projectName">Projectnaam</label>
                <input type="text" id="projectName" placeholder="Bijv. Groot Onderhoud N123">
              </div>
              <div class="field">
                <label for="companyName">Bedrijfsnaam</label>
                <input type="text" id="companyName" placeholder="Bijv. InfraImpact">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="clientName">Opdrachtgever</label>
                <input type="text" id="clientName" placeholder="Bijv. Provincie X">
              </div>
              <div class="field">
                <label for="lcaAuthor">LCA Uitvoerder</label>
                <input type="text" id="lcaAuthor" placeholder="Bijv. Jim van der Kooij">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="projectLifetime">Projectlevensduur (jaar)</label>
                <input type="number" id="projectLifetime" min="1" max="200" step="1" value="50">
              </div>
              <div class="field">
                <label for="projectLocation">Projectadres / Coördinaten</label>
                <input type="text" id="projectLocation" placeholder="Adres, plaats of X/Y-coördinaat">
              </div>
            </div>
          </div>
        </section>

        <!-- Asfaltcentrales -->
        <section class="card">
          <h2>Asfaltcentrales &amp; Transport</h2>
          <p class="lead">Meerdere centrales met bijbehorende transportafstand.</p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="plantName">Asfaltcentrale</label>
                <input type="text" id="plantName" placeholder="Bijv. AC Rotterdam">
              </div>
              <div class="field">
                <label for="plantDistance">Transportkilometers (km)</label>
                <input type="number" id="plantDistance" min="0" step="1" placeholder="Bijv. 45">
                <small>Enkele reis, indicatief.</small>
              </div>
            </div>
            <div class="btn-row">
              <button type="button" class="btn-secondary" onclick="addPlant()">Extra centrale</button>
            </div>
          </div>

          <div class="field-group">
            <label>Geregistreerde centrales</label>
            <div id="plantList" class="list">
              <p class="muted" id="noPlantsText">Nog geen asfaltcentrales toegevoegd.</p>
            </div>
          </div>
        </section>
      </div>

      <div>
        <!-- Mengsels & EPD -->
        <section class="card">
          <h2>Mengsels &amp; Eigenschappen</h2>
          <p class="lead">
            Per mengsel: code, naam, centrale, asfaltsoort (dropdown uit LCApro), brandstof, retourtransport en MKI/GWP-waarden.
            EPD upload vult A1–A3 en D automatisch, maar blijft handmatig aanpasbaar.
          </p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="mixCode">Mengselcode</label>
                <input type="text" id="mixCode" placeholder="Bijv. AC11-DA-70/100">
              </div>
              <div class="field">
                <label for="mixName">Mengselnaam</label>
                <input type="text" id="mixName" placeholder="Bijv. AC 11 deklaag">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="mixPlant">Asfaltcentrale</label>
                <select id="mixPlant">
                  <option value="">Selecteer een asfaltcentrale</option>
                </select>
              </div>
              <div class="field">
                <label for="mixType">Asfaltsoort (LCApro)</label>
                <select id="mixType">
                  <option value="">— kies asfaltsoort —</option>
                  <!-- Uit lca_get_dropdown_data()['asfaltsoorten'] -->
                  <option>01. AC surf zonder PR</option>
                  <option>02. AC surf met 30% PR</option>
                  <option>03. AC surf met gemodificeerd bitumen zonder PR</option>
                  <option>04. AC surf met gemodificeerd bitumen met 30% PR</option>
                  <option>05. AC surf rood, met penbitumen</option>
                  <option>06. AC surf rood, met blank bindmiddel</option>
                  <option>07. AC bin/base 50% PR</option>
                  <option>08. AC bin/base 50% PR met gemodificeerd bitumen</option>
                  <option>09. ZOAB Regulier</option>
                  <option>10. DZOAB</option>
                  <option>11. DZOAB 30% PR</option>
                  <option>12. 2L-ZOAB toplaag met gemodificeerd bitumen</option>
                  <option>13. 2L-ZOAB onderlaag</option>
                  <option>14. 2L-ZOAB onderlaag 30% PR</option>
                  <option>15. SMA 8-11</option>
                  <option>16. SMA 8-11 met gemodificeerd</option>
                  <option>17. SMA 5</option>
                  <option>18. Geluidsreducerende SMA deklaag (obv 8G+)</option>
                  <option>19. Waterbouwasfaltbeton</option>
                  <option>20. Open steenasfalt</option>
                  <option>21. Gietasfalt, waterbouw</option>
                  <option>22. Asfaltmastiek, waterbouw</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="transportFuel">Transportbrandstof</label>
                <select id="transportFuel">
                  <option value="">Kies brandstof</option>
                  <option value="Diesel">Diesel</option>
                  <option value="HVO">HVO</option>
                  <option value="Elektrisch">Elektrisch</option>
                  <option value="Anders">Anders / mix</option>
                </select>
              </div>
              <div class="field">
                <label for="returnTransport">Retourtransport (%)</label>
                <input type="number" id="returnTransport" min="0" max="100" step="1" value="0">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="constructionFuel">Aanlegbrandstof</label>
                <select id="constructionFuel">
                  <option value="">Kies brandstof</option>
                  <option value="Diesel">Diesel</option>
                  <option value="HVO">HVO</option>
                  <option value="Elektrisch">Elektrisch</option>
                </select>
              </div>
              <div class="field">
                <label for="epdFile">EPD Upload (PDF)</label>
                <input type="file" id="epdFile" accept="application/pdf">
                <small>Bij upload worden MKI &amp; GWP A1–A3 + D uitgehaald indien mogelijk.</small>
              </div>
            </div>
          </div>

          <!-- MKI / CO2 velden (met A1-3 en D) -->
          <div class="field-group">
            <h3>MKI-waarden (per functionele eenheid)</h3>
            <div class="field-row">
              <div class="field">
                <label for="mkiA1A3">MKI A1–A3</label>
                <input type="number" id="mkiA1A3" step="any" placeholder="Bijv. 0,85">
              </div>
              <div class="field">
                <label for="mkiD">MKI D</label>
                <input type="number" id="mkiD" step="any" placeholder="Bijv. 0,15">
              </div>
            </div>
            <small>Wordt bij EPD-upload automatisch ingevuld; altijd handmatig aanpasbaar.</small>
          </div>

          <div class="field-group">
            <h3>CO₂ / GWP-waarden (kg CO₂-eq.)</h3>
            <div class="field-row">
              <div class="field">
                <label for="co2A1A3">GWP A1–A3 (kg CO₂-eq.)</label>
                <input type="number" id="co2A1A3" step="any" placeholder="Bijv. 10,5">
              </div>
              <div class="field">
                <label for="co2D">GWP D (kg CO₂-eq.)</label>
                <input type="number" id="co2D" step="any" placeholder="Bijv. 1,2">
              </div>
            </div>
            <small>Ook hier: EPD-upload probeert deze velden te vullen.</small>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" onclick="addMix()">Extra mengsel</button>
          </div>

          <div class="field-group">
            <label>Geregistreerde mengsels</label>
            <div id="mixList" class="list">
              <p class="muted" id="noMixesText">Nog geen mengsels toegevoegd.</p>
            </div>
          </div>
        </section>

        <!-- Export -->
        <section class="card">
          <h2>Exporteren</h2>
          <p class="lead">
            Exporteer alle ingevoerde gegevens naar CSV en PDF voor jouw LCA-rapport of aanbestedingsdossier.
          </p>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="downloadCsv()">Download CSV</button>
            <button type="button" class="btn-secondary" onclick="downloadPdf()">Download PDF</button>
          </div>
          <p class="muted" style="margin-top:8px;">
            De tool rekent niet automatisch door naar project-MKI; de MKI- en GWP-waarden zijn invoer zoals in LCApro.
          </p>
        </section>
      </div>
    </div>
  </main>

  <footer>
    &copy; <span id="year"></span> InfraImpact – MKI &amp; LCA voor de GWW-sector.
  </footer>

  <!-- jsPDF voor PDF-export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ========= HELPERS =========
    const asphaltPlants = [];
    const mixes = [];

    function slugify(name) {
      return (name || 'lca_rapport')
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
    }

    function normalizeMinus(s){ return s ? s.replace(/\u2212/g,'-') : s; }

    function parseNumEUexp(s){
      if(!s) return NaN;
      let str=normalizeMinus(String(s)).trim().replace(/\u202F/g,'').replace(/\s+/g,' ');
      if (str.includes(',') && /[Ee][+\-]?\d+$/.test(str)) str=str.replace(',', '.');
      else if (str.includes(',') && !str.includes('.')) str=str.replace(',', '.');
      else if (str.includes(',') && str.includes('.')) {
        const parts=str.split(',');
        str=parts[0].replace(/\./g,'')+'.'+parts.slice(1).join('');
      }
      str=str.replace(/[^0-9eE\+\-\.]/g,'');
      const n=Number(str);
      return Number.isFinite(n)?n:NaN;
    }

    function looksNumericToken(raw){
      if(!raw) return false;
      const s = normalizeMinus(String(raw)).trim();
      if(/[Ee][+\-]?\d+/.test(s)) return true;
      if(/[\,\.]/.test(s)) return true;
      if(/^\-?\d{2,}$/.test(s)) return true;
      return false;
    }

    async function waitPdf(){ while(!window.pdfjsLib){ await new Promise(r=>setTimeout(r,100)); } }

    async function pdfToText(file){
      await waitPdf();
      const buf = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({data:buf}).promise;
      let text = '';
      for(let p=1; p<=Math.min(8,pdf.numPages); p++){
        const page = await pdf.getPage(p);
        const c = await page.getTextContent();
        text += '\n' + c.items.map(it=>it.str).join(' ');
      }
      return text;
    }

    function pick(re,txt){
      const m = txt.match(re);
      return m ? m[1].trim() : '';
    }

    function extractECITable(txt){
      const t = txt.replace(/\s+/g,' ').replace(/\u00A0/g,' ').trim();
      const re = /(ECI|MKI)\s*euro\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)/i;
      const m = t.match(re);
      if(!m) return null;
      const a13 = m[5], d = m[6];
      if(!looksNumericToken(a13) || !looksNumericToken(d)) return null;
      return { a13Raw:a13, dRaw:d, a13:parseNumEUexp(a13), d:parseNumEUexp(d) };
    }

    function extractLabeledMKI(txt){
      const t = txt.replace(/\s+/g,' ');
      const dash = '[\\-–—~]';
      const a13m = t.match(new RegExp(`\\bA1\\s*${dash}\\s*A3\\b[^\\d\\-]*([\\-]?\\d[\\d\\.\\,]*(?:[Ee][\\+\\-]?\\d+)?)`,'i'));
      const dm   = t.match(/\bD\b[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
      let a13Raw = a13m?.[1] || '';
      let dRaw   = dm?.[1]   || '';
      if(!looksNumericToken(a13Raw)) a13Raw = '';
      if(!looksNumericToken(dRaw))   dRaw   = '';
      const a13 = a13Raw ? parseNumEUexp(a13Raw) : NaN;
      const d   = dRaw   ? parseNumEUexp(dRaw)   : NaN;
      if(!isNaN(a13) || !isNaN(d)) return {a13,d,a13Raw,dRaw};
      return null;
    }

    function extractFromMKIResults(txt){
      const mm = txt.match(/Resultaten[\s\S]{0,400}(?:MKI|ECI)\s+Euro([\s\S]{0,260})/i);
      if(!mm) return null;
      const after=mm[1].replace(/\s+/g,' ').trim();
      const a13m = after.match(/A1\s*[–—\-~]\s*A3[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
      const dm   = after.match(/\bD\b[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
      let a13Raw = a13m?.[1] || '';
      let dRaw   = dm?.[1]   || '';
      if(!looksNumericToken(a13Raw)) a13Raw='';
      if(!looksNumericToken(dRaw))   dRaw='';
      const a13 = a13Raw?parseNumEUexp(a13Raw):NaN;
      const d   = dRaw  ?parseNumEUexp(dRaw)  :NaN;
      if(!isNaN(a13) || !isNaN(d)) return {a13,d,a13Raw,dRaw};
      return null;
    }

    // GWP-extractie (A1–A3 / D) – best effort
    function extractGWPTable(txt){
      const t = txt.replace(/\s+/g,' ').replace(/\u00A0/g,' ').trim();
      const re = /(GWP[^A-Za-z0-9]|GWP\s*\(total\)|GWP\s*totaal)[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)/i;
      const m = t.match(re);
      if(!m) return null;
      const a13 = m[5], d = m[6];
      if(!looksNumericToken(a13) || !looksNumericToken(d)) return null;
      return { a13Raw:a13, dRaw:d, a13:parseNumEUexp(a13), d:parseNumEUexp(d) };
    }

    function extractLabeledGWP(txt){
      const t = txt.replace(/\s+/g,' ');
      const dash='[\\-–—~]';
      const a13m = t.match(new RegExp(`GWP[^\\n]*A1\\s*${dash}\\s*A3[^\\d\\-]*([\\-]?\\d[\\d\\.\\,]*(?:[Ee][\\+\\-]?\\d+)?)`,'i'));
      const dm   = t.match(/GWP[^A-Za-z0-9]*D[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
      let a13Raw = a13m?.[1] || '';
      let dRaw   = dm?.[1]   || '';
      if(!looksNumericToken(a13Raw)) a13Raw='';
      if(!looksNumericToken(dRaw))   dRaw='';
      const a13 = a13Raw?parseNumEUexp(a13Raw):NaN;
      const d   = dRaw  ?parseNumEUexp(dRaw)  :NaN;
      if(!isNaN(a13) || !isNaN(d)) return {a13,d,a13Raw,dRaw};
      return null;
    }

    async function parseEpd(file){
      const text = await pdfToText(file);
      const product = pick(/Product:\s*([^\n]+?)\s+(?:Eenheid|Unit|Producer|Producent)/i, text) || file.name.replace(/\.pdf$/i,'');
      const pcrRaw  = pick(/PCR[:\s]+([^\n]+)$/im, text) || "";
      const pubDate = pick(/(Datum(?:\s+van)?\s+publicatie|Issue date)[:\s]+([0-9]{2}-[0-9]{2}-[0-9]{4})/i, text) || '';

      // MKI
      let a13, d, a13Raw="", dRaw="";
      const eci = extractECITable(text);
      if(eci){ a13=eci.a13; d=eci.d; a13Raw=eci.a13Raw; dRaw=eci.dRaw; }
      if(isNaN(a13) || isNaN(d)){
        const lab = extractLabeledMKI(text);
        if(lab){
          if(isNaN(a13)){ a13=lab.a13; a13Raw=lab.a13Raw||a13Raw; }
          if(isNaN(d)){ d=lab.d; dRaw=lab.dRaw||dRaw; }
        }
      }
      if((isNaN(a13) && isNaN(d)) || (!looksNumericToken(a13Raw)&&!looksNumericToken(dRaw))){
        const res = extractFromMKIResults(text);
        if(res){
          if(isNaN(a13)){ a13=res.a13; a13Raw=res.a13Raw; }
          if(isNaN(d)){ d=res.d; dRaw=res.dRaw; }
        }
      }

      // GWP
      let gwpA13, gwpD, gwpA13Raw="", gwpDRaw="";
      const gwpTab = extractGWPTable(text);
      if(gwpTab){ gwpA13=gwpTab.a13; gwpD=gwpTab.d; gwpA13Raw=gwpTab.a13Raw; gwpDRaw=gwpTab.dRaw; }
      if(isNaN(gwpA13) || isNaN(gwpD)){
        const gwpLab = extractLabeledGWP(text);
        if(gwpLab){
          if(isNaN(gwpA13)){ gwpA13=gwpLab.a13; gwpA13Raw=gwpLab.a13Raw || gwpA13Raw; }
          if(isNaN(gwpD)){ gwpD=gwpLab.d; gwpDRaw=gwpLab.dRaw || gwpDRaw; }
        }
      }

      return {
        product,
        pcr: pcrRaw || "NL-PCR Asfalt 2.0",
        pubDate,
        mkiA1A3:a13,
        mkiD:d,
        mkiA1A3Raw:a13Raw,
        mkiDRaw:dRaw,
        gwpA1A3:gwpA13,
        gwpD:gwpD,
        gwpA1A3Raw:gwpA13Raw,
        gwpDRaw:gwpDRaw
      };
    }

    function parseInputPrecise(el){
      let s = (el.value ?? "").trim();
      if(!s) return NaN;
      s = s.replace(/\u202F/g,'').replace(/\s+/g,' ');
      if (s.includes(',') && /[Ee][+\-]?\d+$/.test(s)) s = s.replace(',', '.');
      else if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
      else if (s.includes(',') && s.includes('.')) {
        const parts=s.split(',');
        s=parts[0].replace(/\./g,'')+'.'+parts.slice(1).join('');
      }
      s = s.replace(/[^0-9eE\+\-\.]/g,'');
      const n = Number(s);
      return Number.isFinite(n)?n:NaN;
    }

    // ========= Asfaltcentrales =========
    function addPlant() {
      const name = document.getElementById('plantName').value.trim();
      const distanceStr = document.getElementById('plantDistance').value;
      const distance = distanceStr === '' ? null : parseFloat(distanceStr);

      if (!name) {
        alert('Vul minimaal de naam van de asfaltcentrale in.');
        return;
      }

      const plant = {
        id: Date.now() + '_' + Math.random().toString(16).slice(2),
        name,
        distanceKm: isNaN(distance) ? null : distance
      };

      asphaltPlants.push(plant);
      document.getElementById('plantName').value = '';
      document.getElementById('plantDistance').value = '';
      renderPlants();
      updateMixPlantOptions();
    }

    function removePlant(id) {
      const idx = asphaltPlants.findIndex(p => p.id === id);
      if (idx !== -1) {
        asphaltPlants.splice(idx, 1);
        renderPlants();
        updateMixPlantOptions();
      }
    }

    function renderPlants() {
      const list = document.getElementById('plantList');
      list.innerHTML = '';

      if (asphaltPlants.length === 0) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.id = 'noPlantsText';
        p.textContent = 'Nog geen asfaltcentrales toegevoegd.';
        list.appendChild(p);
        return;
      }

      asphaltPlants.forEach(plant => {
        const div = document.createElement('div');
        div.className = 'list-item';

        const meta = document.createElement('div');
        meta.className = 'list-meta';

        const title = document.createElement('div');
        title.className = 'list-title';
        title.textContent = plant.name;

        const sub = document.createElement('div');
        sub.className = 'list-sub';
        const dist = plant.distanceKm != null ? plant.distanceKm + ' km transport' : 'Transportafstand: n.v.t.';
        sub.textContent = dist;

        meta.appendChild(title);
        meta.appendChild(sub);

        const actions = document.createElement('div');

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-danger';
        btn.textContent = 'Verwijderen';
        btn.onclick = () => removePlant(plant.id);

        actions.appendChild(btn);

        div.appendChild(meta);
        div.appendChild(actions);

        list.appendChild(div);
      });
    }

    function updateMixPlantOptions() {
      const select = document.getElementById('mixPlant');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Selecteer een asfaltcentrale</option>';

      asphaltPlants.forEach(plant => {
        const opt = document.createElement('option');
        opt.value = plant.id;
        opt.textContent = plant.name;
        select.appendChild(opt);
      });

      if (asphaltPlants.some(p => p.id === currentValue)) {
        select.value = currentValue;
      }
    }

    function getPlantNameById(id) {
      const found = asphaltPlants.find(p => p.id === id);
      return found ? found.name : '—';
    }

    // ========= Mengsels =========
    async function handleEpdUpload(){
      const input = document.getElementById('epdFile');
      const file = input.files[0];
      if (!file) return;
      try {
        const parsed = await parseEpd(file);
        if(!isNaN(parsed.mkiA1A3)) document.getElementById('mkiA1A3').value = parsed.mkiA1A3;
        if(!isNaN(parsed.mkiD))    document.getElementById('mkiD').value    = parsed.mkiD;
        if(!isNaN(parsed.gwpA1A3)) document.getElementById('co2A1A3').value = parsed.gwpA1A3;
        if(!isNaN(parsed.gwpD))    document.getElementById('co2D').value    = parsed.gwpD;
      } catch(e){
        console.warn('EPD lezen mislukt', e);
        alert('Kon MKI/GWP niet automatisch uit de EPD halen. Je kunt de waarden handmatig invullen.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const epdInput = document.getElementById('epdFile');
      if (epdInput) {
        epdInput.addEventListener('change', handleEpdUpload);
      }
    });

    function addMix() {
      const code = document.getElementById('mixCode').value.trim();
      const name = document.getElementById('mixName').value.trim();
      const plantId = document.getElementById('mixPlant').value;
      const type = document.getElementById('mixType').value;
      const transportFuel = document.getElementById('transportFuel').value;
      const returnTransportStr = document.getElementById('returnTransport').value;
      const returnTransport = returnTransportStr === '' ? null : parseFloat(returnTransportStr);
      const constructionFuel = document.getElementById('constructionFuel').value;
      const mkiA1A3 = parseInputPrecise(document.getElementById('mkiA1A3'));
      const mkiD    = parseInputPrecise(document.getElementById('mkiD'));
      const co2A1A3 = parseInputPrecise(document.getElementById('co2A1A3'));
      const co2D    = parseInputPrecise(document.getElementById('co2D'));
      const epdInput = document.getElementById('epdFile');
      const epdFile = epdInput.files[0] || null;
      const epdFileName = epdFile ? epdFile.name : '';

      if (!code || !name) {
        alert('Vul minimaal mengselcode en mengselnaam in.');
        return;
      }
      if (!plantId) {
        alert('Selecteer een asfaltcentrale voor dit mengsel.');
        return;
      }

      const mix = {
        id: Date.now() + '_' + Math.random().toString(16).slice(2),
        code,
        name,
        plantId,
        type,
        transportFuel,
        returnTransport: isNaN(returnTransport) ? null : returnTransport,
        constructionFuel,
        mkiA1A3: isNaN(mkiA1A3) ? null : mkiA1A3,
        mkiD:    isNaN(mkiD)    ? null : mkiD,
        co2A1A3: isNaN(co2A1A3) ? null : co2A1A3,
        co2D:    isNaN(co2D)    ? null : co2D,
        epdFileName
      };

      mixes.push(mix);

      // velden leegmaken (centrale/asfaltsoort laten staan kan ook, maar ik maak ze even schoon)
      document.getElementById('mixCode').value = '';
      document.getElementById('mixName').value = '';
      document.getElementById('transportFuel').value = '';
      document.getElementById('returnTransport').value = '0';
      document.getElementById('constructionFuel').value = '';
      document.getElementById('mkiA1A3').value = '';
      document.getElementById('mkiD').value = '';
      document.getElementById('co2A1A3').value = '';
      document.getElementById('co2D').value = '';
      document.getElementById('epdFile').value = '';

      renderMixes();
    }

    function removeMix(id) {
      const idx = mixes.findIndex(m => m.id === id);
      if (idx !== -1) {
        mixes.splice(idx, 1);
        renderMixes();
      }
    }

    function renderMixes() {
      const list = document.getElementById('mixList');
      list.innerHTML = '';

      if (mixes.length === 0) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.id = 'noMixesText';
        p.textContent = 'Nog geen mengsels toegevoegd.';
        list.appendChild(p);
        return;
      }

      mixes.forEach(mix => {
        const div = document.createElement('div');
        div.className = 'list-item';

        const meta = document.createElement('div');
        meta.className = 'list-meta';

        const title = document.createElement('div');
        title.className = 'list-title';
        title.textContent = mix.code + ' – ' + mix.name;

        const sub1 = document.createElement('div');
        sub1.className = 'list-sub';
        sub1.textContent =
          'Asfaltcentrale: ' + getPlantNameById(mix.plantId) +
          ' · Asfaltsoort: ' + (mix.type || 'n.v.t.');

        const sub2 = document.createElement('div');
        sub2.className = 'list-sub';
        const rt = mix.returnTransport != null ? mix.returnTransport + ' % retour' : 'Retourtransport: n.v.t.';
        sub2.textContent =
          'Transp.: ' + (mix.transportFuel || 'n.v.t.') +
          ' · Aanleg: ' + (mix.constructionFuel || 'n.v.t.') +
          ' · ' + rt;

        const sub3 = document.createElement('div');
        sub3.className = 'list-sub';
        const mkiTot = (mix.mkiA1A3 ?? 0) + (mix.mkiD ?? 0);
        const co2Tot = (mix.co2A1A3 ?? 0) + (mix.co2D ?? 0);
        sub3.textContent =
          'MKI A1–A3: ' + (mix.mkiA1A3 ?? 'n.v.t.') +
          ' · MKI D: ' + (mix.mkiD ?? 'n.v.t.') +
          ' · MKI A–D: ' + (isNaN(mkiTot) ? 'n.v.t.' : mkiTot) +
          ' · GWP A1–A3: ' + (mix.co2A1A3 ?? 'n.v.t.') +
          ' · GWP D: ' + (mix.co2D ?? 'n.v.t.') +
          ' · GWP A–D: ' + (isNaN(co2Tot) ? 'n.v.t.' : co2Tot);

        const sub4 = document.createElement('div');
        sub4.className = 'list-sub';
        sub4.textContent = 'EPD: ' + (mix.epdFileName || 'geen gekoppeld');

        meta.appendChild(title);
        meta.appendChild(sub1);
        meta.appendChild(sub2);
        meta.appendChild(sub3);
        meta.appendChild(sub4);

        const actions = document.createElement('div');

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-danger';
        btn.textContent = 'Verwijderen';
        btn.onclick = () => removeMix(mix.id);

        actions.appendChild(btn);

        div.appendChild(meta);
        div.appendChild(actions);

        list.appendChild(div);
      });
    }

    // ========= CSV =========
    function downloadCsv() {
      if (mixes.length === 0) {
        alert('Voeg minimaal één mengsel toe voordat je exporteert.');
        return;
      }

      const sep = ';';
      let csv = '';

      const projectName = document.getElementById('projectName').value || '';
      const companyName = document.getElementById('companyName').value || '';
      const clientName = document.getElementById('clientName').value || '';
      const lcaAuthor = document.getElementById('lcaAuthor').value || '';
      const projectLifetime = document.getElementById('projectLifetime').value || '';
      const projectLocation = document.getElementById('projectLocation').value || '';

      csv += 'LCA Tool;InfraImpact\n';
      csv += 'Datum;' + new Date().toLocaleDateString('nl-NL') + '\n\n';

      csv += 'Sectie;Veld;Waarde;Eenheid\n';
      csv += 'Project;Projectnaam;' + projectName + ';\n';
      csv += 'Project;Bedrijfsnaam;' + companyName + ';\n';
      csv += 'Project;Opdrachtgever;' + clientName + ';\n';
      csv += 'Project;LCA Uitvoerder;' + lcaAuthor + ';\n';
      csv += 'Project;Projectlevensduur;' + projectLifetime + ';jaar\n';
      csv += 'Project;Projectadres/Coördinaten;' + projectLocation + ';\n\n';

      csv += 'Asfaltcentrales & Transport;;;\n';
      csv += 'Asfaltcentrale;Transportkilometers (km);;\n';
      if (asphaltPlants.length === 0) {
        csv += 'Geen geregistreerde asfaltcentrales;;;\n';
      } else {
        asphaltPlants.forEach(p => {
          const dist = (p.distanceKm != null)
            ? String(p.distanceKm).replace('.', ',')
            : '';
          csv += p.name + sep + dist + sep + sep + '\n';
        });
      }
      csv += '\n';

      csv += 'Mengsels & Eigenschappen;;;;;;;;;;;;;\n';
      csv += [
        'Mengselcode',
        'Mengselnaam',
        'Asfaltcentrale',
        'Asfaltsoort',
        'Transportbrandstof',
        'Retourtransport (%)',
        'Aanlegbrandstof',
        'MKI A1-A3',
        'MKI D',
        'MKI A-D totaal',
        'GWP A1-A3 (kg CO2-eq.)',
        'GWP D (kg CO2-eq.)',
        'GWP A-D totaal (kg CO2-eq.)',
        'EPD bestand'
      ].join(sep) + '\n';

      mixes.forEach(mix => {
        const plantName = getPlantNameById(mix.plantId);
        const mkiTot = (mix.mkiA1A3 ?? 0) + (mix.mkiD ?? 0);
        const co2Tot = (mix.co2A1A3 ?? 0) + (mix.co2D ?? 0);

        const v = (val) => (val == null || isNaN(val)) ? '' : String(val).replace('.', ',');

        csv += [
          mix.code,
          mix.name,
          plantName,
          mix.type || '',
          mix.transportFuel || '',
          mix.returnTransport != null ? v(mix.returnTransport) : '',
          mix.constructionFuel || '',
          v(mix.mkiA1A3),
          v(mix.mkiD),
          (isNaN(mkiTot) ? '' : v(mkiTot)),
          v(mix.co2A1A3),
          v(mix.co2D),
          (isNaN(co2Tot) ? '' : v(co2Tot)),
          mix.epdFileName || ''
        ].join(sep) + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const fileName = 'lca_tool_' + slugify(projectName) + '.csv';
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ========= PDF =========
    function downloadPdf() {
      if (mixes.length === 0) {
        alert('Voeg minimaal één mengsel toe voordat je exporteert.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

      const projectName = document.getElementById('projectName').value || '';
      const companyName = document.getElementById('companyName').value || '';
      const clientName = document.getElementById('clientName').value || '';
      const lcaAuthor = document.getElementById('lcaAuthor').value || '';
      const projectLifetime = document.getElementById('projectLifetime').value || '';
      const projectLocation = document.getElementById('projectLocation').value || '';

      let y = 15;
      const left = 15;
      const lineHeight = 6;

      function addLine(text, size = 10, bold = false) {
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.setFontSize(size);
        const splitted = doc.splitTextToSize(text, 180);
        splitted.forEach(line => {
          if (y > 280) {
            doc.addPage();
            y = 15;
          }
          doc.text(line, left, y);
          y += lineHeight;
        });
      }

      addLine('LCA Tool – InfraImpact', 14, true);
      addLine('LCA Rapport – ' + (projectName || 'onbenoemd project'), 12, true);
      y += 2;

      addLine('Projectgegevens', 11, true);
      addLine('Projectnaam: ' + (projectName || '-'));
      addLine('Bedrijfsnaam: ' + (companyName || '-'));
      addLine('Opdrachtgever: ' + (clientName || '-'));
      addLine('LCA Uitvoerder: ' + (lcaAuthor || '-'));
      addLine('Projectlevensduur: ' + (projectLifetime || '-') + ' jaar');
      addLine('Projectadres/Coördinaten: ' + (projectLocation || '-'));
      y += 3;

      addLine('Asfaltcentrales & Transport', 11, true);
      if (asphaltPlants.length === 0) {
        addLine('Geen asfaltcentrales geregistreerd.');
      } else {
        asphaltPlants.forEach(p => {
          const distText = (p.distanceKm != null) ? p.distanceKm + ' km' : 'n.v.t.';
          addLine('- ' + p.name + ' – transport: ' + distText);
        });
      }
      y += 3;

      addLine('Mengsels & Eigenschappen', 11, true);
      mixes.forEach((mix, index) => {
        const mkiTot = (mix.mkiA1A3 ?? 0) + (mix.mkiD ?? 0);
        const co2Tot = (mix.co2A1A3 ?? 0) + (mix.co2D ?? 0);

        addLine('Mengsel ' + (index + 1), 10, true);
        addLine('Code / naam: ' + mix.code + ' – ' + mix.name);
        addLine('Asfaltcentrale: ' + getPlantNameById(mix.plantId));
        addLine('Asfaltsoort: ' + (mix.type || 'n.v.t.'));
        addLine('Transportbrandstof: ' + (mix.transportFuel || 'n.v.t.'));
        addLine('Retourtransport: ' + (mix.returnTransport != null ? mix.returnTransport + ' %' : 'n.v.t.'));
        addLine('Aanlegbrandstof: ' + (mix.constructionFuel || 'n.v.t.'));
        addLine('MKI A1–A3: ' + (mix.mkiA1A3 != null ? mix.mkiA1A3 : 'n.v.t.') +
                ' · MKI D: ' + (mix.mkiD != null ? mix.mkiD : 'n.v.t.') +
                ' · MKI A–D: ' + (isNaN(mkiTot) ? 'n.v.t.' : mkiTot));
        addLine('GWP A1–A3: ' + (mix.co2A1A3 != null ? mix.co2A1A3 : 'n.v.t.') +
                ' · GWP D: ' + (mix.co2D != null ? mix.co2D : 'n.v.t.') +
                ' · GWP A–D: ' + (isNaN(co2Tot) ? 'n.v.t.' : co2Tot));
        addLine('EPD (bestand): ' + (mix.epdFileName || 'geen gekoppeld'));
        y += 2;
      });

      y += 4;
      addLine('Let op: alle MKI- en GWP-waarden zijn gebruikersinput of afkomstig uit EPD’s.', 8);
      addLine('Gebruik gevalideerde brondata (NMD/EPD) voor definitieve rapportage.', 8);

      const fileName = 'lca_rapport_' + slugify(projectName) + '.pdf';
      doc.save(fileName);
    }
  </script>

  <!-- pdf.js loader (zoals bij EPD-checker) -->
  <script type="module">
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.mjs";
    window.pdfjsLib = pdfjsLib;
  </script>
</body>
</html>
