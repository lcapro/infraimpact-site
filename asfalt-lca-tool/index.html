<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asfalt LCA-tool – project LCA (EN 15804) | InfraImpact</title>
  <meta name="description" content="Stel project-LCA's op voor asfaltmengsels volgens EN 15804 en de Nederlandse bepalingsmethode. Koppel EPD's, transportprofielen en aanleg-/eindefase-profielen.">
  <!-- SEO: maximale indexatie + rijke snippets zonder zichtbare tekstwijziging -->
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  <meta name="googlebot" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
  <meta name="author" content="InfraImpact B.V.">

  <!-- Canonical + Hreflang -->
  <link rel="canonical" href="https://infraimpact.nl/asfalt-lca-tool/">
  <link rel="alternate" hreflang="nl" href="https://infraimpact.nl/asfalt-lca-tool/">
  <link rel="alternate" hreflang="x-default" href="https://infraimpact.nl/asfalt-lca-tool/">

  <!-- Performance hints -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon.png">
  <link rel="icon" type="image/webp" sizes="32x32" href="../assets/favicon.webp">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.webp">
  <meta name="theme-color" content="#2F6F65">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- pdf.js voor EPD parsing -->
  <script type="module">
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.mjs";
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.mjs";
    window.pdfjsLib = pdfjsLib;
  </script>

  <!-- jsPDF voor rapport-generatie -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Structured data: tool + WebPage context -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"Asfalt LCA-tool",
    "applicationCategory":"EngineeringApplication",
    "operatingSystem":"Web",
    "creator":{"@type":"Organization","name":"InfraImpact B.V."},
    "offers":{"@type":"Offer","price":"0","priceCurrency":"EUR"},
    "url":"https://infraimpact.nl/asfalt-lca-tool/"
  }
  </script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "@id":"https://infraimpact.nl/asfalt-lca-tool/#webpage",
    "url":"https://infraimpact.nl/asfalt-lca-tool/",
    "name":"Asfalt LCA-tool – project LCA (EN 15804) | InfraImpact",
    "isPartOf":{"@type":"WebSite","@id":"https://infraimpact.nl/#website"},
    "about":[
      "LCA",
      "MKI",
      "EPD",
      "Asfalt",
      "EN 15804"
    ]
  }
  </script>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D0EC03F60S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D0EC03F60S');
</script>
  
  <style>
    :root { --brand-green:#2F6F65; --brand-blue:#2B536D; --ink:#374151; }

    body {
      background: linear-gradient(120deg, #ffffff, #f8fbfd, #e8f3f0, #eaf3f7);
      background-size: 400% 400%;
      animation: bgMove 60s ease infinite;
      color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    @keyframes bgMove {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .text-gradient {
      background: linear-gradient(90deg, var(--brand-green), var(--brand-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: inline-block;
      padding-bottom: 0.2em;
      overflow: visible;
    }

    .mono {
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .card {
      border-radius: 1.25rem;
      background: #ffffff;
      box-shadow: 0 8px 24px rgba(15,23,42,0.06);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      padding:0.1rem 0.6rem;
      border-radius:999px;
      font-size:0.75rem;
      font-weight:500;
    }
    .badge-epd-ok { background:#ecfdf5; color:#166534; }
    .badge-epd-missing { background:#fef9c3; color:#854d0e; }
    .badge-epd-error { background:#fee2e2; color:#b91c1c; }

    .dropzone {
      position: relative;
      border: 2px dashed #e5e7eb;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .dropzone:hover {
      border-color: #9ca3af;
      background: #f9fafb;
    }
    .dropzone input[type="file"] {
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
  </style>
</head>

<body class="text-gray-800">

  <!-- Eenvoudige nav (je kunt deze vervangen door je bestaande nav) -->
  <nav class="bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between py-3">
      <a href="/" class="flex items-center gap-2">
        <img src="../assets/logo_full.png" alt="InfraImpact logo" class="h-9 w-auto">
      </a>
      <div class="hidden md:flex items-center gap-6 text-sm font-medium">
        <a href="/" class="hover:text-green-700">Home</a>
        <a href="../epd-checker/" class="hover:text-green-700">MKI-toetsing asfalt</a>
        <span class="text-green-700">Asfalt LCA-tool</span>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <div id="toast" class="fixed top-4 right-4 hidden bg-gray-900 text-white text-sm px-4 py-2 rounded-xl shadow-lg z-50"></div>

    <!-- Hero -->
    <header>
      <h1 class="text-3xl md:text-4xl font-extrabold text-gradient">Asfalt LCA-tool (projectniveau)</h1>
      <p class="mt-2 text-gray-700 max-w-3xl">
        Stel project-LCA's op voor asfaltmengsels volgens <strong>EN 15804</strong> en de
        <strong>Nederlandse bepalingsmethode</strong>. Koppel EPD's, kies transport- en aanlegprofielen
        en exporteer een PDF-rapport en CSV.
      </p>
    </header>

    <!-- Projectgegevens -->
    <section class="card p-6 space-y-4" aria-label="Projectgegevens en EPD-koppeling">
      <h2 class="text-xl font-semibold">1. Projectgegevens</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Projectnaam</label>
          <input id="projectnaam" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Bijv. Groot onderhoud N210">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Opdrachtgever</label>
          <input id="opdrachtgever" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Bijv. Provincie Zuid-Holland">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Bedrijfsnaam / adviseur</label>
          <input id="bedrijfsnaam" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="InfraImpact / aannemer">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">LCA-uitvoerder</label>
          <input id="lca-uitvoerder" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Bijv. Jim van der Kooij">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Projectlevensduur (jaar)</label>
          <input id="projectlevensduur" type="number" min="0" step="1" class="w-full border rounded-xl px-3 py-2" value="30">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Projectadres / coördinaten</label>
          <input id="projectadres" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Straat, plaats of RD-coördinaten">
        </div>
      </div>
    </section>

    <!-- Mengsels -->
    <section class="card p-6 space-y-4" aria-label="Berekening en resultaten">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold">2. Asfaltmengsels in het project</h2>
          <p class="text-sm text-gray-600">
            Voeg voor elk asfaltmengsel een regel toe. Koppel een EPD voor A1-A3 en D, kies transport- en aanlegprofielen.
          </p>
        </div>
        <button id="add-mengsel" type="button"
                class="px-4 py-2 rounded-xl bg-green-600 text-white text-sm font-medium hover:bg-green-500">
          + Extra mengsel
        </button>
      </div>

      <div id="mengsels-container" class="space-y-4"></div>
    </section>

    <!-- Export -->
    <section class="flex flex-wrap items-center gap-4" aria-label="Export en acties">
      <button id="btn-pdf" type="button"
              class="px-5 py-2.5 rounded-xl bg-green-700 text-white font-medium hover:bg-green-600 disabled:opacity-50">
        Genereer LCA-rapport (PDF)
      </button>
      <button id="btn-csv" type="button"
              class="px-5 py-2.5 rounded-xl bg-gray-200 text-gray-900 font-medium hover:bg-gray-300 disabled:opacity-50">
        Exporteer CSV
      </button>
      <p class="text-sm text-gray-600">
        PDF en CSV worden gegenereerd op basis van de ingevulde mengsels en EPD-gegevens.
      </p>
    </section>

  </main>

  <script>
  // ====== Kleine helpers ======
  const $ = (sel) => document.querySelector(sel);
  const createEl = (tag, attrs = {}, children = []) => {
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') el.className = v;
      else if (k === 'text') el.textContent = v;
      else el.setAttribute(k, v);
    }
    (Array.isArray(children) ? children : [children]).forEach(c => {
      if (c == null) return;
      if (typeof c === 'string' || typeof c === 'number') el.appendChild(document.createTextNode(String(c)));
      else el.appendChild(c);
    });
    return el;
  };

  function showToast(msg, ok = true) {
    const t = $('#toast');
    if (!t) return;
    t.textContent = msg;
    t.style.backgroundColor = ok ? '#111827' : '#b91c1c';
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 2800);
  }

  function parseNumberInput(el) {
    if (!el) return NaN;
    let s = (el.value || '').trim();
    if (!s) return NaN;
    s = s.replace(/\u202F/g, '').replace(/\s+/g,' ');
    if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
    s = s.replace(/[^0-9eE+.\-]/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmt(n, decimals = 2) {
    if (typeof n !== 'number' || !isFinite(n)) return '—';
    return n.toFixed(decimals).replace('.', ',');
  }

  // ====== Inhoud uit LCApro: asfaltsoorten & data ======
  const ASFALTSOORTEN = [
    "01. AC surf zonder PR",
    "02. AC surf met 30% PR",
    "03. AC surf met gemodificeerd bitumen zonder PR",
    "04. AC surf met gemodificeerd bitumen met 30% PR",
    "05. AC surf rood, met penbitumen",
    "06. AC surf rood, met blank bindmiddel",
    "07. AC bin/base 50% PR",
    "08. AC bin/base 50% PR met gemodificeerd bitumen",
    "09. ZOAB Regulier",
    "10. DZOAB",
    "11. DZOAB 30% PR",
    "12. 2L-ZOAB toplaag met gemodificeerd bitumen",
    "13. 2L-ZOAB onderlaag",
    "14. 2L-ZOAB onderlaag 30% PR",
    "15. SMA 8-11",
    "16. SMA 8-11 met gemodificeerd",
    "17. SMA 5",
    "18. Geluidsreducerende SMA deklaag (obv 8G+)",
    "19. Waterbouwasfaltbeton",
    "20. Open steenasfalt",
    "21. Gietasfalt, waterbouw",
    "22. Asfaltmastiek, waterbouw"
  ];

  // A5 (aanlegfase) MKI per ton asfalt per mengsel + aanlegbrandstof
  const A5_MKI = {
    "01. AC surf zonder PR":                      { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "02. AC surf met 30% PR":                    { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "03. AC surf met gemodificeerd bitumen zonder PR": { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "04. AC surf met gemodificeerd bitumen met 30% PR":{ Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "05. AC surf rood, met penbitumen":          { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "06. AC surf rood, met blank bindmiddel":    { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "07. AC bin/base 50% PR":                    { Diesel: 0.14, HVO: 0.08, Elektrisch: 0.05 },
    "08. AC bin/base 50% PR met gemodificeerd bitumen": { Diesel: 0.14, HVO: 0.08, Elektrisch: 0.05 },
    "09. ZOAB Regulier":                         { Diesel: 0.14, HVO: 0.08, Elektrisch: 0.05 },
    "10. DZOAB":                                 { Diesel: 0.12, HVO: 0.06, Elektrisch: 0.03 },
    "11. DZOAB 30% PR":                          { Diesel: 0.12, HVO: 0.06, Elektrisch: 0.03 },
    "12. 2L-ZOAB toplaag met gemodificeerd bitumen": { Diesel: 0.12, HVO: 0.06, Elektrisch: 0.03 },
    "13. 2L-ZOAB onderlaag":                     { Diesel: 0.12, HVO: 0.06, Elektrisch: 0.03 },
    "14. 2L-ZOAB onderlaag 30% PR":              { Diesel: 0.12, HVO: 0.06, Elektrisch: 0.03 },
    "15. SMA 8-11":                              { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "16. SMA 8-11 met gemodificeerd":            { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "17. SMA 5":                                 { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "18. Geluidsreducerende SMA deklaag (obv 8G+)": { Diesel: 0.26, HVO: 0.14, Elektrisch: 0.10 },
    "19. Waterbouwasfaltbeton":                  { Diesel: 0.21, HVO: 0.12 },
    "20. Open steenasfalt":                      { Diesel: 0.21, HVO: 0.12 },
    "21. Gietasfalt, waterbouw":                 { Diesel: 0.21, HVO: 0.12 },
    "22. Asfaltmastiek, waterbouw":              { Diesel: 0.21, HVO: 0.12 }
  };

  // C1 (sloopfase) MKI per ton asfalt per mengsel + brandstof
  const C1_MKI = {
    "01. AC surf zonder PR":                      { Diesel: 0.13541603, HVO: 0.078024293 },
    "02. AC surf met 30% PR":                    { Diesel: 0.13541603, HVO: 0.078024293 },
    "03. AC surf met gemodificeerd bitumen zonder PR": { Diesel: 0.13541603, HVO: 0.078024293 },
    "04. AC surf met gemodificeerd bitumen met 30% PR":{ Diesel: 0.13541603, HVO: 0.078024293 },
    "05. AC surf rood, met penbitumen":          { Diesel: 0.13541603, HVO: 0.078024293 },
    "06. AC surf rood, met blank bindmiddel":    { Diesel: 0.13541603, HVO: 0.078024293 },
    "07. AC bin/base 50% PR":                    { Diesel: 0.31586755, HVO: 0.18199357 },
    "08. AC bin/base 50% PR met gemodificeerd bitumen": { Diesel: 0.31586755, HVO: 0.18199357 },
    "09. ZOAB Regulier":                         { Diesel: 0.31586755, HVO: 0.18199357 },
    "10. DZOAB":                                 { Diesel: 0.17627297, HVO: 0.101559 },
    "11. DZOAB 30% PR":                          { Diesel: 0.17627297, HVO: 0.101559 },
    "12. 2L-ZOAB toplaag met gemodificeerd bitumen": { Diesel: 0.17627297, HVO: 0.101559 },
    "13. 2L-ZOAB onderlaag":                     { Diesel: 0.17627297, HVO: 0.101559 },
    "14. 2L-ZOAB onderlaag 30% PR":              { Diesel: 0.17627297, HVO: 0.101559 },
    "15. SMA 8-11":                              { Diesel: 0.13541603, HVO: 0.078024293 },
    "16. SMA 8-11 met gemodificeerd":            { Diesel: 0.13541603, HVO: 0.078024293 },
    "17. SMA 5":                                 { Diesel: 0.13541603, HVO: 0.078024293 },
    "18. Geluidsreducerende SMA deklaag (obv 8G+)": { Diesel: 0.13541603, HVO: 0.078024293 },
    "19. Waterbouwasfaltbeton":                  { Diesel: 0.083571103, HVO: 0.048205457 },
    "20. Open steenasfalt":                      { Diesel: 0.083571103, HVO: 0.048205457 },
    "21. Gietasfalt, waterbouw":                 { Diesel: 0.083571103, HVO: 0.048205457 },
    "22. Asfaltmastiek, waterbouw":              { Diesel: 0.083571103, HVO: 0.048205457 }
  };

  // B1 MKI per mengsel
  const B1_MKI = {
    "01. AC surf zonder PR": 0.08,
    "02. AC surf met 30% PR": 0.08,
    "03. AC surf met gemodificeerd bitumen zonder PR": 0.08,
    "04. AC surf met gemodificeerd bitumen met 30% PR": 0.08,
    "05. AC surf rood, met penbitumen": 0.12,
    "06. AC surf rood, met blank bindmiddel": 0.12,
    "07. AC bin/base 50% PR": 0.0,
    "08. AC bin/base 50% PR met gemodificeerd bitumen": 0.0,
    "09. ZOAB Regulier": 0.64,
    "10. DZOAB": 0.64,
    "11. DZOAB 30% PR": 0.64,
    "12. 2L-ZOAB toplaag met gemodificeerd bitumen": 0.64,
    "13. 2L-ZOAB onderlaag": 0.64,
    "14. 2L-ZOAB onderlaag 30% PR": 0.64,
    "15. SMA 8-11": 0.12,
    "16. SMA 8-11 met gemodificeerd": 0.12,
    "17. SMA 5": 0.14,
    "18. Geluidsreducerende SMA deklaag (obv 8G+)": 0.14,
    "19. Waterbouwasfaltbeton": 0.04,
    "20. Open steenasfalt": 1.01,
    "21. Gietasfalt, waterbouw": 0.02,
    "22. Asfaltmastiek, waterbouw": 0.05
  };

  // Levensduur per asfaltsoort
  const LEVENSDUUR = {
    "01. AC surf zonder PR": 15,
    "02. AC surf met 30% PR": 15,
    "03. AC surf met gemodificeerd bitumen zonder PR": 15,
    "04. AC surf met gemodificeerd bitumen met 30% PR": 15,
    "05. AC surf rood, met penbitumen": 15,
    "06. AC surf rood, met blank bindmiddel": 15,
    "07. AC bin/base 50% PR": 30,
    "08. AC bin/base 50% PR met gemodificeerd bitumen": 30,
    "09. ZOAB Regulier": 15,
    "10. DZOAB": 15,
    "11. DZOAB 30% PR": 15,
    "12. 2L-ZOAB toplaag met gemodificeerd bitumen": 15,
    "13. 2L-ZOAB onderlaag": 30,
    "14. 2L-ZOAB onderlaag 30% PR": 30,
    "15. SMA 8-11": 15,
    "16. SMA 8-11 met gemodificeerd": 15,
    "17. SMA 5": 15,
    "18. Geluidsreducerende SMA deklaag (obv 8G+)": 15,
    "19. Waterbouwasfaltbeton": 40,
    "20. Open steenasfalt": 40,
    "21. Gietasfalt, waterbouw": 40,
    "22. Asfaltmastiek, waterbouw": 40
  };

  // C3/C4 (recycling & eindverwerking) per type toepassing
  const C3_MKI = {
    Wegenbouw: 0.15929996,
    Waterbouw: 0.0
  };
  const C4_MKI = {
    Wegenbouw: 0.0,
    Waterbouw: 0.72961418
  };

  // Transportprofielen: exacte namen uit LCApro
  const TRANSPORTBRANDSTOFFEN = [
    "Diesel (euro 5)",
    "Diesel (euro 6)",
    "HVO (euro 5)",
    "HVO (euro 6)",
    "Elektrisch (grijze stroom)",
    "Elektrisch (groene stroom)",
    "Waterstof (elektrolyse grijze stroom)",
    "Waterstof (elektrolyse groene stroom)",
    "Waterstof (SMR grijze stroom)",
    "Waterstof (SMR groene stroom)"
  ];

  // MKI per tkm (zelfde voor A4 en C2, conform transport-data.php)
  const TRANSPORT_MKI_PER_TKM = {
    "Diesel (euro 5)": 0.008598488,
    "Diesel (euro 6)": 0.008029809,
    "HVO (euro 5)": 0.008142933,
    // overige profielen kun je later aanvullen met exact dezelfde waarden als in transport-data.php:
    "Waterstof (elektrolyse groene stroom)": 0.011452738,
    "Waterstof (SMR grijze stroom)": 0.007750517,
    "Waterstof (SMR groene stroom)": 0.007205155
  };

  // ====== EPD parsing (gebaseerd op je bestaande EPD-checker) ======
  function normalizeMinus(s){ return s ? s.replace(/\u2212/g,'-') : s; }

  function parseNumEUexp(s) {
    if (!s) return NaN;
    let str = normalizeMinus(String(s)).trim()
      .replace(/\u202F/g,'')
      .replace(/\s+/g,' ');
    if (str.includes(',') && /[Ee][+\-]?\d+$/.test(str)) {
      str = str.replace(',', '.');
    } else if (str.includes(',') && !str.includes('.')) {
      str = str.replace(',', '.');
    } else if (str.includes(',') && str.includes('.')) {
      const parts = str.split(',');
      str = parts[0].replace(/\./g,'') + '.' + parts.slice(1).join('');
    }
    str = str.replace(/[^0-9eE+\-\.]/g,'');
    const n = Number(str);
    return Number.isFinite(n) ? n : NaN;
  }

  function looksNumericToken(raw) {
    if (!raw) return false;
    const s = normalizeMinus(String(raw)).trim();
    if (/[Ee][+\-]?\d+/.test(s)) return true;
    if (/[\,\.]/.test(s)) return true;
    if (/^\-?\d{2,}$/.test(s)) return true;
    return false;
  }

  async function waitForPdfLib() {
    while (!window.pdfjsLib) {
      await new Promise(r => setTimeout(r, 80));
    }
  }

  async function pdfToText(file) {
    await waitForPdfLib();
    const buf = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
    let text = '';
    const pages = Math.min(8, pdf.numPages);
    for (let p = 1; p <= pages; p++) {
      const page = await pdf.getPage(p);
      const c = await page.getTextContent();
      text += '\n' + c.items.map(it => it.str).join(' ');
    }
    return text;
  }

  function pick(regex, txt) {
    const m = txt.match(regex);
    return m ? m[1].trim() : '';
  }

  function extractECITable(txt) {
    const t = txt.replace(/\s+/g,' ').replace(/\u00A0/g,' ').trim();
    const re = /(ECI|MKI)\s*euro\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)\s+([\-]?\d[\d\.\,]*(?:[Ee][+\-]?\d+)?)/i;
    const m = t.match(re);
    if (!m) return null;
    const a13 = m[5], d = m[6];
    if (!looksNumericToken(a13) || !looksNumericToken(d)) return null;
    return { a13Raw:a13, dRaw:d, a13:parseNumEUexp(a13), d:parseNumEUexp(d) };
  }

  function extractLabeledValues(txt) {
    const t = txt.replace(/\s+/g,' ');
    const dash = '[\\-–—~]';
    const a13m = t.match(new RegExp(`\\bA1\\s*${dash}\\s*A3\\b[^\\d\\-]*([\\-]?\\d[\\d\\.\\,]*(?:[Ee][\\+\\-]?\\d+)?)`,'i'));
    const dm   = t.match(/\bD\b[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
    let a13Raw = a13m?.[1] || '';
    let dRaw   = dm?.[1]   || '';
    if (!looksNumericToken(a13Raw)) a13Raw = '';
    if (!looksNumericToken(dRaw))   dRaw   = '';
    const a13 = a13Raw ? parseNumEUexp(a13Raw) : NaN;
    const d   = dRaw   ? parseNumEUexp(dRaw)   : NaN;
    if (!isNaN(a13) || !isNaN(d)) return { a13,d,a13Raw,dRaw };
    return null;
  }

  function extractFromMKIResults(txt) {
    const mm = txt.match(/Resultaten[\s\S]{0,400}(?:MKI|ECI)\s+Euro([\s\S]{0,260})/i);
    if (!mm) return null;
    const after = mm[1].replace(/\s+/g,' ').trim();
    const a13m = after.match(/A1\s*[–—\-~]\s*A3[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
    const dm   = after.match(/\bD\b[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
    let a13Raw = a13m?.[1] || '';
    let dRaw   = dm?.[1]   || '';
    if (!looksNumericToken(a13Raw)) a13Raw='';
    if (!looksNumericToken(dRaw))   dRaw='';
    const a13 = a13Raw ? parseNumEUexp(a13Raw) : NaN;
    const d   = dRaw   ? parseNumEUexp(dRaw)   : NaN;
    if (!isNaN(a13) || !isNaN(d)) return { a13,d,a13Raw,dRaw };
    return null;
  }

  function cleanPCR(txt) {
    if (/NL-?PCR\s*Asfalt\s*2\.0/i.test(txt)) return "NL-PCR Asfalt 2.0";
    if (/PCR[^0-9]*2\.0/i.test(txt)) return "PCR 2.0";
    return "NL-PCR Asfalt 2.0";
  }

  // GWP A1-A3 en D (best effort)
  function extractGWP(txt) {
    const t = txt.replace(/\s+/g,' ');
    const dash = '[\\-–—~]';
    const a13m = t.match(new RegExp(`GWP[^A-Za-z0-9]*A1\\s*${dash}\\s*A3[^\\d\\-]*([\\-]?\\d[\\d\\.,]*(?:[Ee][+\\-]?\\d+)?)`,'i'));
    const dm   = t.match(/GWP[^A-Za-z0-9]*D[^0-9\-]*([\-]?\d[\d\.,]*(?:[Ee][+\-]?\d+)?)/i);
    let a13Raw = a13m?.[1] || '';
    let dRaw   = dm?.[1]   || '';
    if (!looksNumericToken(a13Raw)) a13Raw = '';
    if (!looksNumericToken(dRaw))   dRaw   = '';
    const a13 = a13Raw ? parseNumEUexp(a13Raw) : NaN;
    const d   = dRaw   ? parseNumEUexp(dRaw)   : NaN;
    if (!isNaN(a13) || !isNaN(d)) return { a13,d,a13Raw,dRaw };
    return null;
  }

  async function parseEpd(file) {
    const text = await pdfToText(file);
    const product = pick(/Product:\s*([^\n]+?)\s+(?:Eenheid|Unit|Producer|Producent)/i, text) || file.name.replace(/\.pdf$/i,'');
    const pcrRaw  = pick(/PCR[:\s]+([^\n]+)$/im, text) || "";
    const pcr     = cleanPCR(pcrRaw || text);
    const pubDate = pick(/(Datum(?:\s+van)?\s+publicatie|Issue date)[:\s]+([0-9]{2}-[0-9]{2}-[0-9]{4})/i, text) || '';

    let a13, d, a13Raw="", dRaw="";
    const eci = extractECITable(text);
    if (eci) {
      a13 = eci.a13; d = eci.d;
      a13Raw = eci.a13Raw; dRaw = eci.dRaw;
    }
    if (isNaN(a13) || isNaN(d)) {
      const lab = extractLabeledValues(text);
      if (lab) {
        if (isNaN(a13)) { a13 = lab.a13; a13Raw = lab.a13Raw || a13Raw; }
        if (isNaN(d))   { d   = lab.d;   dRaw   = lab.dRaw   || dRaw;   }
      }
    }
    if ((isNaN(a13) && isNaN(d)) || (!looksNumericToken(a13Raw) && !looksNumericToken(dRaw))) {
      const res = extractFromMKIResults(text);
      if (res) {
        if (isNaN(a13)) { a13 = res.a13; a13Raw = res.a13Raw; }
        if (isNaN(d))   { d   = res.d;   dRaw   = res.dRaw;   }
      }
    }

    let gwpA13 = NaN, gwpD = NaN;
    const gwp = extractGWP(text);
    if (gwp) {
      gwpA13 = gwp.a13;
      gwpD   = gwp.d;
    }

    return {
      product,
      pcr,
      pubDate,
      mkiA1A3: a13,
      mkiD: d,
      gwpA1A3: gwpA13,
      gwpD: gwpD
    };
  }

  // ====== Mengsel UI & state ======
  let mengselCounter = 0;
  const mengsels = [];

  function defaultToepassing(asfaltsoort) {
    if (!asfaltsoort) return 'Wegenbouw';
    if (/waterbouw/i.test(asfaltsoort)) return 'Waterbouw';
    return 'Wegenbouw';
  }

  function buildTransportBrandstofSelect() {
    const sel = createEl('select', { class: 'w-full border rounded-xl px-3 py-2 text-sm' });
    TRANSPORTBRANDSTOFFEN.forEach(name => {
      sel.appendChild(createEl('option', { value: name, text: name }));
    });
    return sel;
  }

  function buildAsfaltsoortSelect() {
    const sel = createEl('select', { class: 'w-full border rounded-xl px-3 py-2 text-sm' });
    sel.appendChild(createEl('option', { value: '', text: '— kies asfaltsoort —' }));
    ASFALTSOORTEN.forEach(name => {
      sel.appendChild(createEl('option', { value: name, text: name }));
    });
    return sel;
  }

  function addMengselCard(initial = {}) {
    const idx = ++mengselCounter;

    const card = createEl('div', { class: 'card p-4 space-y-3' });
    const header = createEl('div', { class: 'flex items-center justify-between gap-2' }, [
      createEl('div', { class: 'text-sm font-semibold' }, `Mengsel ${idx}`),
      createEl('div', { class: 'flex items-center gap-2' }, [
        createEl('span', { class: 'badge badge-epd-missing', text: 'EPD: niet gekoppeld' }),
        createEl('button', {
          type: 'button',
          class: 'text-xs text-red-600 hover:underline'
        }, 'Verwijderen')
      ])
    ]);

    const badge = header.querySelector('.badge');

    const grid1 = createEl('div', { class: 'grid md:grid-cols-4 gap-3' });
    const mengselCodeInput = createEl('input', {
      type: 'text',
      class: 'w-full border rounded-xl px-3 py-2 text-sm',
      placeholder: 'Mengselcode'
    });
    const mengselNaamInput = createEl('input', {
      type: 'text',
      class: 'w-full border rounded-xl px-3 py-2 text-sm',
      placeholder: 'Mengselnaam'
    });
    const asfaltsoortSelect = buildAsfaltsoortSelect();
    const toepassingSelect = createEl('select', {
      class: 'w-full border rounded-xl px-3 py-2 text-sm'
    }, [
      createEl('option', { value:'Wegenbouw', text:'Wegenbouw' }),
      createEl('option', { value:'Waterbouw', text:'Waterbouw' })
    ]);

    grid1.append(
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Mengselcode'),
        mengselCodeInput
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Mengselnaam'),
        mengselNaamInput
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Asfaltsoort'),
        asfaltsoortSelect
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Toepassingstype'),
        toepassingSelect
      ])
    );

    const grid2 = createEl('div', { class: 'grid md:grid-cols-4 gap-3' });
    const centraleInput = createEl('input', {
      type: 'text',
      class: 'w-full border rounded-xl px-3 py-2 text-sm',
      placeholder: 'Asfaltcentrale'
    });
    const afstandInput = createEl('input', {
      type: 'number',
      min: '0',
      step: '1',
      class: 'w-full border rounded-xl px-3 py-2 text-sm',
      value: '50'
    });
    const retourInput = createEl('input', {
      type: 'number',
      min: '0',
      step: '1',
      class: 'w-full border rounded-xl px-3 py-2 text-sm',
      value: '0'
    });
    const transportBrandstofSelect = buildTransportBrandstofSelect();

    grid2.append(
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Asfaltcentrale'),
        centraleInput
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Transportafstand (A4, km, enkel)'),
        afstandInput
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Retourtransport A4 (%)'),
        retourInput
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Transportbrandstof (A4)'),
        transportBrandstofSelect
      ])
    );

    const grid3 = createEl('div', { class: 'grid md:grid-cols-3 gap-3' });

    const aanlegBrandstofSelect = createEl('select', {
      class: 'w-full border rounded-xl px-3 py-2 text-sm'
    }, [
      createEl('option', { value:'Diesel', text:'Diesel' }),
      createEl('option', { value:'HVO', text:'HVO' }),
      createEl('option', { value:'Elektrisch', text:'Elektrisch' })
    ]);
    const refLifeSpan = createEl('span', {
      class: 'inline-flex items-center text-xs text-gray-600 px-3 py-2 rounded-xl bg-gray-50'
    }, 'Referentielevensduur: — jaar');

    // C2 inputs
    const c2AfstandInput = createEl('input', {
      type: 'number',
      min: '0',
      step: '1',
      class: 'w-full border rounded-xl px-2 py-1 text-xs',
      value: '50'
    });
    const c2RetourInput = createEl('input', {
      type: 'number',
      min: '0',
      step: '1',
      class: 'w-full border rounded-xl px-2 py-1 text-xs',
      value: '0'
    });
    const c2BrandstofSelect = buildTransportBrandstofSelect();

    grid3.append(
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Aanlegbrandstof (A5)'),
        aanlegBrandstofSelect
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'Referentielevensduur mengsel'),
        refLifeSpan
      ]),
      createEl('div', {}, [
        createEl('label', { class:'block text-xs font-medium mb-1' }, 'C2-transport (einde levensduur)'),
        createEl('div', { class:'grid grid-cols-1 gap-1' }, [
          createEl('div', {}, [
            createEl('span', { class:'block text-[11px] text-gray-600 mb-0.5' }, 'Afstand C2 (km, enkel)'),
            c2AfstandInput
          ]),
          createEl('div', {}, [
            createEl('span', { class:'block text-[11px] text-gray-600 mb-0.5' }, 'Retour C2 (%)'),
            c2RetourInput
          ]),
          createEl('div', {}, [
            createEl('span', { class:'block text-[11px] text-gray-600 mb-0.5' }, 'Brandstof C2'),
            c2BrandstofSelect
          ])
        ])
      ])
    );

    // EPD dropzone
    const epdDrop = createEl('label', { class: 'dropzone flex items-center justify-between px-3 py-2 text-xs text-gray-600 mt-2' }, [
      createEl('div', {}, [
        createEl('div', { class:'font-medium text-gray-800 mb-0.5' }, 'EPD (PDF)'),
        createEl('div', {}, 'Kies of sleep een EPD voor dit mengsel. A1–A3 en D (MKI) worden automatisch gelezen.')
      ]),
      createEl('div', { class:'px-3 py-1 rounded-xl bg-gray-900 text-white text-xs' }, 'Kies PDF…'),
      createEl('input', { type:'file', accept:'application/pdf,.pdf' })
    ]);

    const epdFileInput = epdDrop.querySelector('input[type="file"]');

    // Tabel met MKI & GWP A1-A3 en D
    const table = createEl('table', { class:'w-full text-xs mono border border-gray-200 rounded-lg overflow-hidden mt-2' });
    const tHead = createEl('thead', { class:'bg-gray-50' }, [
      createEl('tr', {}, [
        createEl('th', { class:'px-2 py-1 text-left' }, ''),
        createEl('th', { class:'px-2 py-1 text-left' }, 'A1-A3'),
        createEl('th', { class:'px-2 py-1 text-left' }, 'D')
      ])
    ]);
    const tBody = createEl('tbody');

    const mkiA1A3Input = createEl('input', { type:'number', step:'any', class:'w-full border rounded px-1 py-0.5 text-xs' });
    const mkiDInput    = createEl('input', { type:'number', step:'any', class:'w-full border rounded px-1 py-0.5 text-xs' });
    const gwpA1A3Input = createEl('input', { type:'number', step:'any', class:'w-full border rounded px-1 py-0.5 text-xs' });
    const gwpDInput    = createEl('input', { type:'number', step:'any', class:'w-full border rounded px-1 py-0.5 text-xs' });

    tBody.append(
      createEl('tr', {}, [
        createEl('td', { class:'px-2 py-1 font-medium' }, 'MKI [€/FU]'),
        createEl('td', { class:'px-2 py-1' }, mkiA1A3Input),
        createEl('td', { class:'px-2 py-1' }, mkiDInput)
      ]),
      createEl('tr', {}, [
        createEl('td', { class:'px-2 py-1 font-medium' }, 'GWP [kg CO₂-eq/FU]'),
        createEl('td', { class:'px-2 py-1' }, gwpA1A3Input),
        createEl('td', { class:'px-2 py-1' }, gwpDInput)
      ])
    );
    table.append(tHead, tBody);

    card.append(header, grid1, grid2, grid3, epdDrop, table);
    $('#mengsels-container').appendChild(card);

    // State object
    const state = {
      idx,
      card,
      badge,
      mengselCodeInput,
      mengselNaamInput,
      asfaltsoortSelect,
      toepassingSelect,
      centraleInput,
      afstandInput,
      retourInput,
      transportBrandstofSelect,
      aanlegBrandstofSelect,
      refLifeSpan,
      c2AfstandInput,
      c2RetourInput,
      c2BrandstofSelect,
      epdFileInput,
      mkiA1A3Input,
      mkiDInput,
      gwpA1A3Input,
      gwpDInput,
      epdMeta: null
    };
    mengsels.push(state);

    // Initial defaults if provided
    if (initial.asfaltsoort) {
      asfaltsoortSelect.value = initial.asfaltsoort;
    }
    toepassingSelect.value = defaultToepassing(asfaltsoortSelect.value);

    // Event handlers
    header.querySelector('button').addEventListener('click', () => {
      card.remove();
      const idxIn = mengsels.indexOf(state);
      if (idxIn >= 0) mengsels.splice(idxIn, 1);
    });

    asfaltsoortSelect.addEventListener('change', () => {
      const asf = asfaltsoortSelect.value;
      toepassingSelect.value = defaultToepassing(asf);
      const lv = LEVENSDUUR[asf];
      refLifeSpan.textContent = 'Referentielevensduur: ' + (lv ? lv + ' jaar' : '— jaar');
    });

    epdFileInput.addEventListener('change', async () => {
      const file = epdFileInput.files && epdFileInput.files[0];
      if (!file) return;
      badge.textContent = 'EPD: lezen…';
      badge.className = 'badge badge-epd-missing';
      try {
        const info = await parseEpd(file);
        state.epdMeta = info;

        if (!isNaN(info.mkiA1A3)) mkiA1A3Input.value = info.mkiA1A3.toFixed(4);
        if (!isNaN(info.mkiD))    mkiDInput.value    = info.mkiD.toFixed(4);
        if (!isNaN(info.gwpA1A3)) gwpA1A3Input.value = info.gwpA1A3.toFixed(4);
        if (!isNaN(info.gwpD))    gwpDInput.value    = info.gwpD.toFixed(4);

        badge.textContent = 'EPD: gekoppeld';
        badge.className = 'badge badge-epd-ok';
        showToast(`EPD gekoppeld aan mengsel ${idx}`, true);
      } catch (e) {
        console.error(e);
        badge.textContent = 'EPD: fout bij lezen';
        badge.className = 'badge badge-epd-error';
        showToast('Kon EPD niet uitlezen. Vul A1-A3 en D handmatig in.', false);
      }
    });

    // Standaard: C2-afstand en brandstof initialiseren gelijk aan A4
    c2AfstandInput.value = afstandInput.value;
    c2BrandstofSelect.value = transportBrandstofSelect.value;

    return state;
  }

  // ====== Impactberekening per mengsel (incl. C2) ======
  function computeImpactsForMengsel(m) {
    const asf = m.asfaltsoortSelect.value || '';
    if (!asf) return null;

    const mkiA1A3 = parseNumberInput(m.mkiA1A3Input);
    const mkiD    = parseNumberInput(m.mkiDInput);
    const gwpA1A3 = parseNumberInput(m.gwpA1A3Input);
    const gwpD    = parseNumberInput(m.gwpDInput);

    // A4
    const kmA4      = parseNumberInput(m.afstandInput) || 0;
    const retourA4  = parseNumberInput(m.retourInput) || 0;
    const effKmA4   = kmA4 * (1 + retourA4 / 100);
    const fuelA4    = m.transportBrandstofSelect.value;
    const tFactorA4 = TRANSPORT_MKI_PER_TKM[fuelA4];
    const mkiA4     = typeof tFactorA4 === 'number' ? tFactorA4 * effKmA4 : NaN;

    // A5
    const a5Data  = A5_MKI[asf] || {};
    const fuelA5  = m.aanlegBrandstofSelect.value;
    const mkiA5   = typeof a5Data[fuelA5] === 'number' ? a5Data[fuelA5] : NaN;

    // B1 (optioneel geschaald met levensduur)
    const b1Val   = B1_MKI[asf];
    const lvRef   = LEVENSDUUR[asf] || null;
    const lvProj  = parseInt($('#projectlevensduur').value || '0', 10) || null;
    let mkiB1     = typeof b1Val === 'number' ? b1Val : NaN;
    if (lvRef && lvProj && lvProj !== lvRef) {
      mkiB1 = b1Val * (lvProj / lvRef);
    }

    // C1
    const toep    = m.toepassingSelect.value === 'Waterbouw' ? 'Waterbouw' : 'Wegenbouw';
    const c1Data  = C1_MKI[asf] || {};
    const c1Fuel  = (fuelA5 === 'HVO' || fuelA5 === 'Diesel') ? fuelA5 : 'Diesel';
    const mkiC1   = typeof c1Data[c1Fuel] === 'number' ? c1Data[c1Fuel] : NaN;

    // C2 (transport naar verwerker / stort)
    const kmC2      = parseNumberInput(m.c2AfstandInput) || 0;
    const retourC2  = parseNumberInput(m.c2RetourInput) || 0;
    const effKmC2   = kmC2 * (1 + retourC2 / 100);
    const fuelC2    = m.c2BrandstofSelect.value;
    const tFactorC2 = TRANSPORT_MKI_PER_TKM[fuelC2];
    const mkiC2     = typeof tFactorC2 === 'number' ? tFactorC2 * effKmC2 : NaN;

    // C3 & C4 (type-afhankelijk)
    const mkiC3   = C3_MKI[toep];
    const mkiC4   = C4_MKI[toep];

    const totalWithoutD = [mkiA1A3, mkiA4, mkiA5, mkiB1, mkiC1, mkiC2, mkiC3, mkiC4]
      .filter(v => typeof v === 'number' && isFinite(v))
      .reduce((sum, v) => sum + v, 0);

    const totalWithD = totalWithoutD + (isFinite(mkiD) ? mkiD : 0);

    const gwpTotal = [gwpA1A3, gwpD]
      .filter(v => typeof v === 'number' && isFinite(v))
      .reduce((sum, v) => sum + v, 0);

    return {
      asfaltsoort: asf,
      toepassing: toep,
      mengselcode: m.mengselCodeInput.value || '',
      mengselnaam: m.mengselNaamInput.value || '',
      centrale: m.centraleInput.value || '',
      transportAfstandKm: kmA4,
      retourPct: retourA4,
      transportBrandstof: fuelA4,
      aanlegBrandstof: fuelA5,
      c2AfstandKm: kmC2,
      c2RetourPct: retourC2,
      c2Brandstof: fuelC2,
      refLife: lvRef,
      projectLife: lvProj,
      mkiA1A3,
      mkiA4,
      mkiA5,
      mkiB1,
      mkiC1,
      mkiC2,
      mkiC3,
      mkiC4,
      mkiD,
      mkiTotalAD: totalWithD,
      gwpA1A3,
      gwpD,
      gwpTotalAD: gwpTotal,
      epdMeta: m.epdMeta
    };
  }

  // ====== PDF generatie (incl. C2) ======
  function generatePdf() {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      showToast('jsPDF niet geladen', false);
      return;
    }
    const { jsPDF } = window.jspdf;
    const data = mengsels
      .map(computeImpactsForMengsel)
      .filter(x => x && x.asfaltsoort);

    if (!data.length) {
      showToast('Voeg minimaal één mengsel toe met asfaltsoort en MKI-data.', false);
      return;
    }

    const projectnaam   = $('#projectnaam').value || 'Project';
    const opdrachtgever = $('#opdrachtgever').value || '';
    const bedrijfsnaam  = $('#bedrijfsnaam').value || '';
    const lcaUitvoerder = $('#lca-uitvoerder').value || '';
    const projLife      = $('#projectlevensduur').value || '';
    const projAdres     = $('#projectadres').value || '';

    const doc = new jsPDF({ unit:'mm', format:'a4' });

    // Voorblad
    doc.setFont('helvetica','bold');
    doc.setFontSize(20);
    doc.text('LCA-rapport asfalt', 20, 30);
    doc.setFontSize(14);
    doc.text(projectnaam, 20, 40);

    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    let y = 55;
    const today = new Date();
    const dateStr = today.toLocaleDateString('nl-NL');

    const infoLines = [
      ['Opdrachtgever', opdrachtgever],
      ['Bedrijf / adviseur', bedrijfsnaam],
      ['LCA-uitvoerder', lcaUitvoerder],
      ['Projectlevensduur', projLife ? projLife + ' jaar' : '—'],
      ['Projectadres / coördinaten', projAdres || '—'],
      ['Datum', dateStr],
      ['Normenkader', 'EN 15804 + NMD Bepalingsmethode (MKI, €/FU)']
    ];
    infoLines.forEach(([label, value]) => {
      doc.text(`${label}:`, 20, y);
      doc.text(String(value), 70, y);
      y += 6;
    });

    doc.addPage();

    // Samenvattingstabel per mengsel
    doc.setFont('helvetica','bold');
    doc.setFontSize(12);
    doc.text('Overzicht mengsels en MKI A–D', 20, 20);
    doc.setFontSize(9);

    const colX = [20, 45, 105, 130, 150, 170];
    let rowY = 28;

    doc.text('Code', colX[0], rowY);
    doc.text('Mengselnaam', colX[1], rowY);
    doc.text('Asfaltsoort', colX[2], rowY);
    doc.text('MKI A1-A3', colX[3], rowY);
    doc.text('MKI A–D totaal', colX[4], rowY);
    doc.text('GWP A–D', colX[5], rowY);
    rowY += 4;
    doc.setDrawColor(200,200,200);
    doc.line(20, rowY, 190, rowY);
    rowY += 4;

    doc.setFont('helvetica','normal');

    data.forEach(mix => {
      if (rowY > 270) {
        doc.addPage();
        rowY = 20;
      }
      doc.text(mix.mengselcode || '-', colX[0], rowY);
      doc.text((mix.mengselnaam || '').slice(0,25), colX[1], rowY);
      doc.text((mix.asfaltsoort || '').slice(0,30), colX[2], rowY);
      doc.text(fmt(mix.mkiA1A3), colX[3], rowY);
      doc.text(fmt(mix.mkiTotalAD), colX[4], rowY);
      doc.text(fmt(mix.gwpTotalAD), colX[5], rowY);
      rowY += 5;
    });

    // Detailpagina per mengsel
    data.forEach((mix, idx) => {
      doc.addPage();
      doc.setFont('helvetica','bold');
      doc.setFontSize(12);
      doc.text(`Mengsel ${idx+1}: ${mix.mengselcode || ''} ${mix.mengselnaam || ''}`, 20, 20);
      doc.setFontSize(9);
      doc.setFont('helvetica','normal');

      let y = 28;
      const metaLines = [
        ['Asfaltsoort', mix.asfaltsoort],
        ['Toepassingstype', mix.toepassing],
        ['Asfaltcentrale', mix.centrale || '—'],
        ['Transportafstand A4 (enkel)', `${fmt(mix.transportAfstandKm,1)} km`],
        ['Retourtransport A4', `${fmt(mix.retourPct,1)} %`],
        ['Transportbrandstof (A4)', mix.transportBrandstof],
        ['Aanlegbrandstof (A5)', mix.aanlegBrandstof],
        ['C2-transportafstand (enkel)', `${fmt(mix.c2AfstandKm,1)} km`],
        ['Retourtransport C2', `${fmt(mix.c2RetourPct,1)} %`],
        ['Transportbrandstof (C2)', mix.c2Brandstof],
        ['Referentielevensduur mengsel', mix.refLife ? mix.refLife + ' jaar' : '—'],
        ['Projectlevensduur', mix.projectLife ? mix.projectLife + ' jaar' : '—'],
        ['EPD product', mix.epdMeta?.product || '—'],
        ['PCR', mix.epdMeta?.pcr || '—'],
        ['Publicatiedatum EPD', mix.epdMeta?.pubDate || '—']
      ];
      metaLines.forEach(([label,value]) => {
        if (y > 260) {
          doc.addPage(); y = 20;
        }
        doc.text(label + ':', 20, y);
        doc.text(String(value), 70, y);
        y += 5;
      });

      y += 4;
      if (y > 260) { doc.addPage(); y = 20; }

      // Tabel modules A1-A3, A4, A5, B1, C1, C2, C3, C4, D
      doc.setFont('helvetica','bold');
      doc.text('Module-overzicht volgens EN 15804', 20, y);
      y += 6;
      doc.setFont('helvetica','normal');

      const headerY = y;
      doc.text('Module', 20, headerY);
      doc.text('Omschrijving', 45, headerY);
      doc.text('MKI [€/FU]', 140, headerY);
      doc.text('GWP [kg CO₂-eq/FU]', 165, headerY);
      y += 4;
      doc.line(20, y, 190, y);
      y += 4;

      const rows = [
        ['A1-A3', 'Productfase (grondstoffen, productie)', mix.mkiA1A3, mix.gwpA1A3],
        ['A4', 'Transport naar werk (vrachtwagen, tkm)', mix.mkiA4, NaN],
        ['A5', 'Aanlegfase (asfaltset, walsen etc.)', mix.mkiA5, NaN],
        ['B1', 'Gebruikfase (uitloging, functie)', mix.mkiB1, NaN],
        ['C1', 'Sloopfase', mix.mkiC1, NaN],
        ['C2', 'Transport naar verwerker / stort', mix.mkiC2, NaN],
        ['C3', 'Recycling / breken', mix.mkiC3, NaN],
        ['C4', 'Eindverwerking', mix.mkiC4, NaN],
        ['D', 'Potentieel buiten systeemgrens', mix.mkiD, mix.gwpD]
      ];

      rows.forEach(([mod, desc, mki, gwp]) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(mod, 20, y);
        doc.text(desc.slice(0,60), 45, y);
        doc.text(fmt(mki), 140, y, { align:'right' });
        doc.text(fmt(gwp), 190, y, { align:'right' });
        y += 5;
      });

      y += 4;
      if (y > 270) { doc.addPage(); y = 20; }
      doc.setFont('helvetica','bold');
      doc.text('MKI totaal A–D:', 20, y);
      doc.text(fmt(mix.mkiTotalAD) + ' €/FU', 60, y);
      y += 5;
      doc.text('GWP totaal A–D:', 20, y);
      doc.text(fmt(mix.gwpTotalAD) + ' kg CO₂-eq/FU', 60, y);
    });

    const fileName = 'LCA-asfalt-' + (projectnaam || 'rapport').replace(/[^a-z0-9]+/gi,'_') + '.pdf';
    doc.save(fileName);
  }

  // ====== CSV generatie (incl. C2) ======
  function exportCsv() {
    const data = mengsels
      .map(computeImpactsForMengsel)
      .filter(x => x && x.asfaltsoort);

    if (!data.length) {
      showToast('Geen mengsels met complete data voor CSV.', false);
      return;
    }

    const headers = [
      'Mengselcode','Mengselnaam','Asfaltsoort','Toepassingstype',
      'Asfaltcentrale',
      'Transportafstand_A4_km','Retourtransport_A4_pct','Transportbrandstof_A4',
      'Aanlegbrandstof_A5',
      'C2_afstand_km','C2_retour_pct','Transportbrandstof_C2',
      'Ref_levensduur_j','Project_levensduur_j',
      'MKI_A1A3','MKI_A4','MKI_A5','MKI_B1','MKI_C1','MKI_C2','MKI_C3','MKI_C4','MKI_D','MKI_A_D_totaal',
      'GWP_A1A3','GWP_D','GWP_A_D_totaal'
    ];

    const lines = [headers.join(';')];

    function csvNum(n) {
      if (typeof n !== 'number' || !isFinite(n)) return '';
      return n.toString().replace('.', ',');
    }

    data.forEach(mix => {
      const row = [
        mix.mengselcode,
        mix.mengselnaam,
        mix.asfaltsoort,
        mix.toepassing,
        mix.centrale,
        csvNum(mix.transportAfstandKm),
        csvNum(mix.retourPct),
        mix.transportBrandstof,
        mix.aanlegBrandstof,
        csvNum(mix.c2AfstandKm),
        csvNum(mix.c2RetourPct),
        mix.c2Brandstof,
        mix.refLife != null ? mix.refLife : '',
        mix.projectLife != null ? mix.projectLife : '',
        csvNum(mix.mkiA1A3),
        csvNum(mix.mkiA4),
        csvNum(mix.mkiA5),
        csvNum(mix.mkiB1),
        csvNum(mix.mkiC1),
        csvNum(mix.mkiC2),
        csvNum(mix.mkiC3),
        csvNum(mix.mkiC4),
        csvNum(mix.mkiD),
        csvNum(mix.mkiTotalAD),
        csvNum(mix.gwpA1A3),
        csvNum(mix.gwpD),
        csvNum(mix.gwpTotalAD)
      ].map(v => {
        const s = String(v ?? '');
        return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      });
      lines.push(row.join(';'));
    });

    const bom = "\uFEFF";
    const blob = new Blob([bom + lines.join('\n')], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'LCA-asfalt-resultaten.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== Init ======
  document.addEventListener('DOMContentLoaded', () => {
    $('#add-mengsel').addEventListener('click', () => addMengselCard());
    addMengselCard(); // start met 1 mengsel

    $('#btn-pdf').addEventListener('click', generatePdf);
    $('#btn-csv').addEventListener('click', exportCsv);
  });
  </script>

</body>
</html>
