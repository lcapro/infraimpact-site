<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LCA Tool – InfraImpact</title>
  <meta name="description" content="Voer project-, asfaltcentrale- en mengselgegevens in en exporteer een LCA-rapport als CSV en PDF. Een tool van InfraImpact.">

  <!-- Favicons - pad eventueel aanpassen -->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon.png">
  <link rel="icon" type="image/webp" sizes="32x32" href="assets/favicon.webp">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <meta name="theme-color" content="#2F3B52">

  <style>
    :root {
      --ii-bg: #f5f7fa;
      --ii-primary: #1c4f82;
      --ii-primary-dark: #153b60;
      --ii-accent: #00a676;
      --ii-text: #1f2933;
      --ii-border: #d0d7e2;
      --ii-radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--ii-bg);
      color: var(--ii-text);
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid var(--ii-border);
    }

    .header-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--ii-primary-dark);
      text-decoration: none;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    nav a {
      text-decoration: none;
      color: var(--ii-text);
      font-size: 0.95rem;
    }

    nav a.active {
      color: var(--ii-primary);
      font-weight: 600;
    }

    main {
      max-width: 1080px;
      margin: 24px auto 40px;
      padding: 0 16px 40px;
    }

    h1.page-title {
      margin: 0 0 8px;
      font-size: 1.8rem;
      color: var(--ii-primary-dark);
    }

    p.page-subtitle {
      margin: 0 0 20px;
      max-width: 720px;
      color: #4b5563;
      font-size: 0.96rem;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 20px;
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: var(--ii-radius);
      border: 1px solid var(--ii-border);
      padding: 16px 16px 18px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
      margin-bottom: 18px;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 1.1rem;
      color: var(--ii-primary-dark);
    }

    .card h3 {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 0.98rem;
      color: var(--ii-primary-dark);
    }

    .card p.lead {
      margin: 0 0 12px;
      font-size: 0.88rem;
      color: #6b7280;
    }

    .field-group {
      margin-bottom: 10px;
    }

    .field-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #4b5563;
    }

    input[type="text"],
    input[type="number"],
    select {
      border-radius: 6px;
      border: 1px solid var(--ii-border);
      padding: 7px 9px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #ffffff;
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--ii-primary);
      box-shadow: 0 0 0 1px rgba(28,79,130,0.08);
    }

    small {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--ii-primary);
      color: #ffffff;
    }

    .btn-primary:hover {
      background: var(--ii-primary-dark);
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--ii-primary-dark);
      border: 1px solid var(--ii-border);
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .list {
      border-radius: 8px;
      border: 1px dashed var(--ii-border);
      padding: 8px;
      background: #f9fafb;
      max-height: 260px;
      overflow-y: auto;
    }

    .list-item {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--ii-border);
      padding: 7px 9px;
      margin-bottom: 7px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.8rem;
    }

    .list-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .list-title {
      font-weight: 600;
      color: var(--ii-primary-dark);
    }

    .list-sub {
      color: #6b7280;
      font-size: 0.78rem;
    }

    .muted {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 8px;
    }

    th, td {
      padding: 4px 3px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      font-weight: 600;
      font-size: 0.78rem;
      color: #4b5563;
    }

    footer {
      border-top: 1px solid var(--ii-border);
      padding: 14px 16px 18px;
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      background: #ffffff;
    }
  </style>
</head>
<body>
  <!-- Vervang deze header indien gewenst met je bestaande header -->
  <header>
    <div class="header-inner">
      <a class="logo" href="index.html">InfraImpact</a>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="projecten.html">Projecten</a></li>
          <li><a href="epd-checker.html">MKI-toetsing asfalt</a></li>
          <li><a href="lca-tool.html" class="active">LCA Tool</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <h1 class="page-title">LCA Tool</h1>
    <p class="page-subtitle">
      Voer de basisgegevens van het LCA-rapport in, inclusief asfaltcentrales en mengselgegevens (incl. EPD’s). 
      Exporteer vervolgens het overzicht als CSV én PDF voor dossiervorming of rapportage.
    </p>

    <div class="grid">
      <div>
        <!-- LCA Rapport Invoeren -->
        <section class="card">
          <h2>LCA Rapport Invoeren</h2>
          <p class="lead">Deze sectie volgt de structuur van de LCApro-tool: projectgegevens, opdrachtgever en uitvoerder.</p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="projectName">Projectnaam</label>
                <input type="text" id="projectName" placeholder="Bijv. Groot Onderhoud N123">
              </div>
              <div class="field">
                <label for="companyName">Bedrijfsnaam</label>
                <input type="text" id="companyName" placeholder="Bijv. InfraImpact">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="clientName">Opdrachtgever</label>
                <input type="text" id="clientName" placeholder="Bijv. Provincie X">
              </div>
              <div class="field">
                <label for="lcaAuthor">LCA Uitvoerder</label>
                <input type="text" id="lcaAuthor" placeholder="Bijv. Jim van der Kooij">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="projectLifetime">Projectlevensduur (jaar)</label>
                <input type="number" id="projectLifetime" min="1" max="200" step="1" value="50">
              </div>
              <div class="field">
                <label for="projectLocation">Projectadres / Coördinaten</label>
                <input type="text" id="projectLocation" placeholder="Adres, plaats of X/Y-coördinaat">
              </div>
            </div>
          </div>
        </section>

        <!-- Asfaltcentrales & Transport -->
        <section class="card">
          <h2>Asfaltcentrales &amp; Transport</h2>
          <p class="lead">Voeg één of meerdere asfaltcentrales toe met bijbehorende transportafstand in km.</p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="plantName">Asfaltcentrale</label>
                <input type="text" id="plantName" placeholder="Bijv. AC Rotterdam">
              </div>
              <div class="field">
                <label for="plantDistance">Transportkilometers (km)</label>
                <input type="number" id="plantDistance" min="0" step="1" placeholder="Bijv. 45">
                <small>Enkele reis, indicatief.</small>
              </div>
            </div>
            <div class="btn-row">
              <button type="button" class="btn-secondary" onclick="addPlant()">Extra centrale</button>
            </div>
          </div>

          <div class="field-group">
            <label>Geregistreerde centrales</label>
            <div id="plantList" class="list">
              <p class="muted" id="noPlantsText">Nog geen asfaltcentrales toegevoegd.</p>
            </div>
          </div>
        </section>
      </div>

      <div>
        <!-- Mengsels & Eigenschappen -->
        <section class="card">
          <h2>Mengsels &amp; Eigenschappen</h2>
          <p class="lead">
            Vul per asfaltmengsel de code, naam, centrale, asfaltsoort, brandstof, retourtransport en MKI/CO₂ in – 
            net als in de LCApro-tool. EPD’s kun je als PDF koppelen.
          </p>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="mixCode">Mengselcode</label>
                <input type="text" id="mixCode" placeholder="Bijv. AC11-DA-70/100">
              </div>
              <div class="field">
                <label for="mixName">Mengselnaam</label>
                <input type="text" id="mixName" placeholder="Bijv. AC 11 deklaag">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="mixPlant">Asfaltcentrale</label>
                <select id="mixPlant">
                  <option value="">Selecteer een asfaltcentrale</option>
                </select>
              </div>
              <div class="field">
                <label for="mixType">Asfaltsoort</label>
                <input type="text" id="mixType" placeholder="Bijv. DZOAB, AC, SMA">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="transportFuel">Transportbrandstof</label>
                <select id="transportFuel">
                  <option value="">Kies brandstof</option>
                  <option value="Diesel">Diesel</option>
                  <option value="HVO">HVO</option>
                  <option value="Elektrisch">Elektrisch</option>
                  <option value="Anders">Anders / mix</option>
                </select>
              </div>
              <div class="field">
                <label for="returnTransport">Retourtransport (%)</label>
                <input type="number" id="returnTransport" min="0" max="100" step="1" value="0">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="constructionFuel">Aanlegbrandstof</label>
                <select id="constructionFuel">
                  <option value="">Kies brandstof</option>
                  <option value="Diesel">Diesel</option>
                  <option value="HVO">HVO</option>
                  <option value="Elektrisch">Elektrisch</option>
                </select>
                <small>Zoals in de LCApro-tool (Diesel / HVO / Elektrisch).</small>
              </div>
              <div class="field">
                <label for="a1a3">A1-A3 D (MKI)</label>
                <input type="number" id="a1a3" step="0.001" placeholder="Bijv. 0,85">
                <small>Eventuele opgesplitste A1-A3(+D)-waarde (optioneel).</small>
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="mkiValue">MKI waarde</label>
                <input type="number" id="mkiValue" step="0.001" placeholder="Bijv. 1,23">
              </div>
              <div class="field">
                <label for="co2Value">CO₂ waarde (kg CO₂-eq.)</label>
                <input type="number" id="co2Value" step="0.001" placeholder="Bijv. 10,5">
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div class="field">
                <label for="epdFile">EPD Upload (PDF)</label>
                <input type="file" id="epdFile" accept="application/pdf">
                <small>Bestandsnaam wordt meegenomen in CSV/PDF (inhoud wordt niet geüpload).</small>
              </div>
            </div>

            <div class="btn-row">
              <button type="button" class="btn-secondary" onclick="addMix()">Extra mengsel</button>
            </div>
          </div>

          <div class="field-group">
            <label>Geregistreerde mengsels</label>
            <div id="mixList" class="list">
              <p class="muted" id="noMixesText">Nog geen mengsels toegevoegd.</p>
            </div>
          </div>
        </section>

        <!-- Export -->
        <section class="card">
          <h2>Exporteren</h2>
          <p class="lead">
            Exporteer alle ingevoerde gegevens naar CSV of PDF als basis voor je LCA-rapport of aanbestedingsdossier.
          </p>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="downloadCsv()">Download CSV</button>
            <button type="button" class="btn-secondary" onclick="downloadPdf()">Download PDF</button>
          </div>
          <p class="muted" style="margin-top:8px;">
            De tool doet geen automatische MKI-berekeningen; alle MKI- en CO₂-waarden zijn invoervelden, 
            net zoals in je bestaande LCApro-tool.
          </p>
        </section>
      </div>
    </div>
  </main>

  <footer>
    &copy; <span id="year"></span> InfraImpact – MKI &amp; LCA voor de GWW-sector.
  </footer>

  <!-- jsPDF voor PDF-export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ====== Data-structuren ======
    const asphaltPlants = [];
    const mixes = [];

    function slugify(name) {
      return (name || 'lca_rapport')
        .toString()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
    }

    // ====== Asfaltcentrales ======
    function addPlant() {
      const name = document.getElementById('plantName').value.trim();
      const distanceStr = document.getElementById('plantDistance').value;
      const distance = distanceStr === '' ? null : parseFloat(distanceStr);

      if (!name) {
        alert('Vul minimaal de naam van de asfaltcentrale in.');
        return;
      }

      const plant = {
        id: Date.now() + '_' + Math.random().toString(16).slice(2),
        name,
        distanceKm: isNaN(distance) ? null : distance
      };

      asphaltPlants.push(plant);
      document.getElementById('plantName').value = '';
      document.getElementById('plantDistance').value = '';
      renderPlants();
      updateMixPlantOptions();
    }

    function removePlant(id) {
      const idx = asphaltPlants.findIndex(p => p.id === id);
      if (idx !== -1) {
        asphaltPlants.splice(idx, 1);
        renderPlants();
        updateMixPlantOptions();
      }
    }

    function renderPlants() {
      const list = document.getElementById('plantList');
      list.innerHTML = '';

      if (asphaltPlants.length === 0) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.id = 'noPlantsText';
        p.textContent = 'Nog geen asfaltcentrales toegevoegd.';
        list.appendChild(p);
        return;
      }

      asphaltPlants.forEach(plant => {
        const div = document.createElement('div');
        div.className = 'list-item';

        const meta = document.createElement('div');
        meta.className = 'list-meta';

        const title = document.createElement('div');
        title.className = 'list-title';
        title.textContent = plant.name;

        const sub = document.createElement('div');
        sub.className = 'list-sub';
        const dist = plant.distanceKm != null ? plant.distanceKm + ' km transport' : 'Transportafstand: n.v.t.';
        sub.textContent = dist;

        meta.appendChild(title);
        meta.appendChild(sub);

        const actions = document.createElement('div');

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-danger';
        btn.textContent = 'Verwijderen';
        btn.onclick = () => removePlant(plant.id);

        actions.appendChild(btn);

        div.appendChild(meta);
        div.appendChild(actions);

        list.appendChild(div);
      });
    }

    function updateMixPlantOptions() {
      const select = document.getElementById('mixPlant');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Selecteer een asfaltcentrale</option>';

      asphaltPlants.forEach(plant => {
        const opt = document.createElement('option');
        opt.value = plant.id;
        opt.textContent = plant.name;
        select.appendChild(opt);
      });

      if (asphaltPlants.some(p => p.id === currentValue)) {
        select.value = currentValue;
      }
    }

    function getPlantNameById(id) {
      const found = asphaltPlants.find(p => p.id === id);
      return found ? found.name : '—';
    }

    // ====== Mengsels ======
    function addMix() {
      const code = document.getElementById('mixCode').value.trim();
      const name = document.getElementById('mixName').value.trim();
      const plantId = document.getElementById('mixPlant').value;
      const type = document.getElementById('mixType').value.trim();
      const transportFuel = document.getElementById('transportFuel').value;
      const returnTransportStr = document.getElementById('returnTransport').value;
      const returnTransport = returnTransportStr === '' ? null : parseFloat(returnTransportStr);
      const constructionFuel = document.getElementById('constructionFuel').value;
      const a1a3Str = document.getElementById('a1a3').value;
      const a1a3 = a1a3Str === '' ? null : parseFloat(a1a3Str);
      const mkiStr = document.getElementById('mkiValue').value;
      const mki = mkiStr === '' ? null : parseFloat(mkiStr);
      const co2Str = document.getElementById('co2Value').value;
      const co2 = co2Str === '' ? null : parseFloat(co2Str);
      const epdInput = document.getElementById('epdFile');
      const epdFile = epdInput.files[0] || null;
      const epdFileName = epdFile ? epdFile.name : '';

      if (!code || !name) {
        alert('Vul minimaal mengselcode en mengselnaam in.');
        return;
      }
      if (!plantId) {
        alert('Selecteer een asfaltcentrale voor dit mengsel.');
        return;
      }
      if (mki == null || isNaN(mki)) {
        alert('Vul een geldige MKI-waarde in voor het mengsel.');
        return;
      }

      const mix = {
        id: Date.now() + '_' + Math.random().toString(16).slice(2),
        code,
        name,
        plantId,
        type,
        transportFuel,
        returnTransport: isNaN(returnTransport) ? null : returnTransport,
        constructionFuel,
        a1a3: isNaN(a1a3) ? null : a1a3,
        mki,
        co2: (co2 == null || isNaN(co2)) ? null : co2,
        epdFileName
      };

      mixes.push(mix);

      // velden leegmaken (centrale laten staan is soms handig)
      document.getElementById('mixCode').value = '';
      document.getElementById('mixName').value = '';
      document.getElementById('mixType').value = '';
      document.getElementById('transportFuel').value = '';
      document.getElementById('returnTransport').value = '0';
      document.getElementById('constructionFuel').value = '';
      document.getElementById('a1a3').value = '';
      document.getElementById('mkiValue').value = '';
      document.getElementById('co2Value').value = '';
      document.getElementById('epdFile').value = '';

      renderMixes();
    }

    function removeMix(id) {
      const idx = mixes.findIndex(m => m.id === id);
      if (idx !== -1) {
        mixes.splice(idx, 1);
        renderMixes();
      }
    }

    function renderMixes() {
      const list = document.getElementById('mixList');
      list.innerHTML = '';

      if (mixes.length === 0) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.id = 'noMixesText';
        p.textContent = 'Nog geen mengsels toegevoegd.';
        list.appendChild(p);
        return;
      }

      mixes.forEach(mix => {
        const div = document.createElement('div');
        div.className = 'list-item';

        const meta = document.createElement('div');
        meta.className = 'list-meta';

        const title = document.createElement('div');
        title.className = 'list-title';
        title.textContent = mix.code + ' – ' + mix.name;

        const sub1 = document.createElement('div');
        sub1.className = 'list-sub';
        sub1.textContent =
          'Asfaltcentrale: ' + getPlantNameById(mix.plantId) +
          ' · Asfaltsoort: ' + (mix.type || 'n.v.t.');

        const sub2 = document.createElement('div');
        sub2.className = 'list-sub';
        const rt = mix.returnTransport != null ? mix.returnTransport + ' % retour' : 'Retourtransport: n.v.t.';
        const a1a3 = mix.a1a3 != null ? 'A1-A3 D: ' + mix.a1a3 : 'A1-A3 D: n.v.t.';
        const co2 = mix.co2 != null ? 'CO₂: ' + mix.co2 + ' kg' : 'CO₂: n.v.t.';
        const epd = mix.epdFileName ? 'EPD: ' + mix.epdFileName : 'EPD: geen gekoppeld';
        sub2.textContent =
          'Transp.: ' + (mix.transportFuel || 'n.v.t.') +
          ' · Aanleg: ' + (mix.constructionFuel || 'n.v.t.') +
          ' · ' + rt;

        const sub3 = document.createElement('div');
        sub3.className = 'list-sub';
        sub3.textContent =
          a1a3 + ' · MKI: ' + mix.mki + ' · ' + co2 + ' · ' + epd;

        meta.appendChild(title);
        meta.appendChild(sub1);
        meta.appendChild(sub2);
        meta.appendChild(sub3);

        const actions = document.createElement('div');

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-danger';
        btn.textContent = 'Verwijderen';
        btn.onclick = () => removeMix(mix.id);

        actions.appendChild(btn);

        div.appendChild(meta);
        div.appendChild(actions);

        list.appendChild(div);
      });
    }

    // ====== CSV EXPORT ======
    function downloadCsv() {
      if (mixes.length === 0) {
        alert('Voeg minimaal één mengsel toe voordat je exporteert.');
        return;
      }

      const sep = ';';
      let csv = '';

      const projectName = document.getElementById('projectName').value || '';
      const companyName = document.getElementById('companyName').value || '';
      const clientName = document.getElementById('clientName').value || '';
      const lcaAuthor = document.getElementById('lcaAuthor').value || '';
      const projectLifetime = document.getElementById('projectLifetime').value || '';
      const projectLocation = document.getElementById('projectLocation').value || '';

      // kop
      csv += 'LCA Tool;InfraImpact\n';
      csv += 'Datum;' + new Date().toLocaleDateString('nl-NL') + '\n\n';

      csv += 'Sectie;Veld;Waarde;Eenheid\n';
      csv += 'Project;Projectnaam;' + projectName + ';\n';
      csv += 'Project;Bedrijfsnaam;' + companyName + ';\n';
      csv += 'Project;Opdrachtgever;' + clientName + ';\n';
      csv += 'Project;LCA Uitvoerder;' + lcaAuthor + ';\n';
      csv += 'Project;Projectlevensduur;' + projectLifetime + ';jaar\n';
      csv += 'Project;Projectadres/Coördinaten;' + projectLocation + ';\n\n';

      // centrales
      csv += 'Asfaltcentrales & Transport;;;\n';
      csv += 'Asfaltcentrale;Transportkilometers (km);;\n';
      if (asphaltPlants.length === 0) {
        csv += 'Geen geregistreerde asfaltcentrales;;;\\n';
      } else {
        asphaltPlants.forEach(p => {
          const dist = (p.distanceKm != null)
            ? String(p.distanceKm).replace('.', ',')
            : '';
          csv += p.name + sep + dist + sep + sep + '\\n';
        });
      }
      csv += '\n';

      // mengsels
      csv += 'Mengsels & Eigenschappen;;;;;;;;;;\n';
      csv += [
        'Mengselcode',
        'Mengselnaam',
        'Asfaltcentrale',
        'Asfaltsoort',
        'Transportbrandstof',
        'Retourtransport (%)',
        'Aanlegbrandstof',
        'A1-A3 D',
        'MKI waarde',
        'CO2 waarde (kg CO2-eq.)',
        'EPD bestand'
      ].join(sep) + '\\n';

      mixes.forEach(mix => {
        const plantName = getPlantNameById(mix.plantId);
        const rt = mix.returnTransport != null ? String(mix.returnTransport).replace('.', ',') : '';
        const a1a3 = mix.a1a3 != null ? String(mix.a1a3).replace('.', ',') : '';
        const mki = mix.mki != null ? String(mix.mki).replace('.', ',') : '';
        const co2 = mix.co2 != null ? String(mix.co2).replace('.', ',') : '';

        csv += [
          mix.code,
          mix.name,
          plantName,
          mix.type || '',
          mix.transportFuel || '',
          rt,
          mix.constructionFuel || '',
          a1a3,
          mki,
          co2,
          mix.epdFileName || ''
        ].join(sep) + '\\n';
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const fileName = 'lca_tool_' + slugify(projectName) + '.csv';
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ====== PDF EXPORT ======
    async function downloadPdf() {
      if (mixes.length === 0) {
        alert('Voeg minimaal één mengsel toe voordat je exporteert.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

      const projectName = document.getElementById('projectName').value || '';
      const companyName = document.getElementById('companyName').value || '';
      const clientName = document.getElementById('clientName').value || '';
      const lcaAuthor = document.getElementById('lcaAuthor').value || '';
      const projectLifetime = document.getElementById('projectLifetime').value || '';
      const projectLocation = document.getElementById('projectLocation').value || '';

      let y = 15;
      const left = 15;
      const lineHeight = 6;

      function addLine(text, size = 10, bold = false) {
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.setFontSize(size);
        const splitted = doc.splitTextToSize(text, 180);
        splitted.forEach(line => {
          if (y > 280) {
            doc.addPage();
            y = 15;
          }
          doc.text(line, left, y);
          y += lineHeight;
        });
      }

      addLine('LCA Tool – InfraImpact', 14, true);
      addLine('LCA Rapport – ' + (projectName || 'onbenoemd project'), 12, true);
      y += 2;

      addLine('Projectgegevens', 11, true);
      addLine('Projectnaam: ' + (projectName || '-'));
      addLine('Bedrijfsnaam: ' + (companyName || '-'));
      addLine('Opdrachtgever: ' + (clientName || '-'));
      addLine('LCA Uitvoerder: ' + (lcaAuthor || '-'));
      addLine('Projectlevensduur: ' + (projectLifetime || '-') + ' jaar');
      addLine('Projectadres/Coördinaten: ' + (projectLocation || '-'));
      y += 3;

      addLine('Asfaltcentrales & Transport', 11, true);
      if (asphaltPlants.length === 0) {
        addLine('Geen asfaltcentrales geregistreerd.');
      } else {
        asphaltPlants.forEach(p => {
          const distText = (p.distanceKm != null) ? p.distanceKm + ' km' : 'n.v.t.';
          addLine('- ' + p.name + ' – transport: ' + distText);
        });
      }
      y += 3;

      addLine('Mengsels & Eigenschappen', 11, true);
      mixes.forEach((mix, index) => {
        addLine('Mengsel ' + (index + 1), 10, true);
        addLine('Code / naam: ' + mix.code + ' – ' + mix.name);
        addLine('Asfaltcentrale: ' + getPlantNameById(mix.plantId));
        addLine('Asfaltsoort: ' + (mix.type || 'n.v.t.'));
        addLine('Transportbrandstof: ' + (mix.transportFuel || 'n.v.t.'));
        addLine('Retourtransport: ' + (mix.returnTransport != null ? mix.returnTransport + ' %' : 'n.v.t.'));
        addLine('Aanlegbrandstof: ' + (mix.constructionFuel || 'n.v.t.'));
        addLine('A1-A3 D: ' + (mix.a1a3 != null ? mix.a1a3 : 'n.v.t.'));
        addLine('MKI waarde: ' + (mix.mki != null ? mix.mki : 'n.v.t.'));
        addLine('CO₂ waarde: ' + (mix.co2 != null ? mix.co2 + ' kg CO₂-eq.' : 'n.v.t.'));
        addLine('EPD (bestand): ' + (mix.epdFileName || 'geen gekoppeld'));
        y += 2;
      });

      y += 4;
      addLine('Let op: alle MKI- en CO₂-waarden zijn gebruikersinput.', 8);
      addLine('Gebruik gevalideerde brondata (bijv. NMD/EPD) voor definitieve rapportage.', 8);

      const fileName = 'lca_rapport_' + slugify(projectName) + '.pdf';
      doc.save(fileName);
    }
  </script>
</body>
</html>
