<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MKI-toetsing asfalt check (v2.5)</title>
<meta name="description" content="Controleer asfalt-EPD’s tegen uniforme MKI-plafondwaarden 2025 (PCR 2.0).">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.min.js"></script>
<style>
  body{font-family:Inter,system-ui,sans-serif}
  .dropzone{position:relative;border:2px dashed #e5e7eb;border-radius:1rem;cursor:pointer;transition:.2s}
  .dropzone:hover{border-color:#9ca3af;background:#f9fafb}
  .drop-input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.15rem .5rem;border-radius:.7rem;font-size:.75rem}
  .badge-pass{background:#ecfdf5;color:#065f46}
  .badge-fail{background:#fef2f2;color:#991b1b}
  .badge-info{background:#eff6ff;color:#1e40af}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .hint{font-size:.8rem;color:#6b7280}
  .highlight-col{background:#dcfce7!important}
</style>
</head>

<body class="bg-gray-50 text-gray-900">
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-bold">MKI-toetsing asfalt check (v2.5)</h1>
    <a href="/" class="text-sm text-gray-600 hover:text-gray-900">← Terug naar home</a>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
  <div id="toast" class="hidden fixed top-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-xl shadow"></div>

  <!-- Eisen + jaarselectie -->
  <section class="bg-white rounded-2xl shadow p-6 space-y-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h2 class="text-xl font-semibold">Uniforme MKI-plafondwaarden 2025 (PCR 2.0)</h2>
        <p class="hint">Automatisch geladen eisenset</p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Kies jaar van de eis</label>
        <select id="year-target" class="border rounded-xl px-3 py-2">
          <option>2022</option>
          <option>2024</option>
          <option selected>2026</option>
          <option>2028</option>
          <option>2030</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto mt-4">
      <table id="eisen-table" class="min-w-full text-sm border border-gray-200"></table>
    </div>
  </section>

  <!-- Upload -->
  <section class="bg-white rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Upload één of meer EPD’s (PDF)</h2>
    <div id="epd-drop" class="dropzone p-6 bg-gray-50">
      <input id="epd-files" type="file" accept="application/pdf,.pdf" multiple class="drop-input" />
      <div class="pointer-events-none flex items-center justify-between gap-4">
        <div>
          <p class="font-medium">Sleep hier je EPD-PDF’s heen of klik</p>
          <p class="text-sm text-gray-500">Meerdere tegelijk toegestaan.</p>
        </div>
        <span class="px-4 py-2 rounded-xl bg-gray-900 text-white">Kies PDF’s…</span>
      </div>
    </div>

    <div id="epd-list" class="space-y-4"></div>

    <div class="flex items-center gap-4">
      <button id="run-checks" type="button" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-500 disabled:opacity-50" disabled>Controleer & opslaan</button>
      <button id="export-csv" type="button" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800 disabled:opacity-50" disabled>Exporteer CSV</button>
    </div>

    <div id="results" class="mt-4"></div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
function el(t,a={},c=[]){const n=document.createElement(t);
 for(const[k,v]of Object.entries(a)){k==="class"?n.className=v:k==="html"?n.innerHTML=v:n.setAttribute(k,v);}
 (Array.isArray(c)?c:[c]).forEach(x=>{if(x==null)return;if(typeof x==="string"||typeof x==="number")n.appendChild(document.createTextNode(String(x)));else n.appendChild(x);});
 return n;}
function toast(m,ok=true){const t=$("#toast");t.textContent=m;t.classList.remove("hidden");t.style.background=ok?"#111827":"#991b1b";setTimeout(()=>t.classList.add("hidden"),2600);}
function fmtNL(n){return (typeof n!=="number"||isNaN(n))?"—":n.toFixed(2).replace(".",",");}

/* ===== Dataset (Uniforme MKI-plafondwaarden 2025 PCR 2.0) ===== */
const MKI_EISEN={jaar:[2022,2024,2026,2028,2030],
  plafonds:{
"AC surf":[9.9,9.1,8.2,7.5,6.7],"AC surf, minimaal 30% PR":[8.6,6.9,6.2,5.6,5.1],
"AC surf met gemodificeerd bitumen":[11.6,10.6,9.5,8.7,7.9],
"AC surf, minimaal 30% PR met gemodificeerd bitumen":[9.9,7.4,7.1,6.7,6.4],
"AC surf rood":[22.1,17.7,17.0,16.4,15.8],
"AC bin/base, minimaal 50% PR":[4.9,4.5,4.1,3.6,3.1],
"AC bin/base, minimaal 50% PR met gemodificeerd bitumen":[5.5,5.1,4.6,4.1,3.6],
"AC bin/base minimaal 60% PR":[NaN,3.9,3.5,3.2,2.9],
"SMA 8-11":[10.8,8.7,7.9,7.3,6.7],"SMA 8-11 met gemodificeerd bitumen":[12.8,11.8,10.7,10.0,9.2],
"SMA 8-11 minimaal 30% PR":[NaN,7.2,6.5,5.9,5.4],"SMA 5":[12.0,11.9,11.7,10.7,9.8],
"SMA geluidsreducerende deklaag (op basis van 8G+)":[13.2,13.1,12.9,11.8,10.8],
"SMA rood":[18.5,18.2,17.5,16.8,NaN],"ZOAB regulier":[9.8,8.8,7.7,6.3,4.9],
"ZOAB regulier+ / DZOAB":[10.5,9.5,8.4,7.0,5.6],"DZOAB, minimaal 30% PR":[8.8,8.8,7.8,6.5,5.2],
"2L ZOAB toplaag met gemodificeerd bitumen":[12.7,12.6,12.4,10.6,8.7],
"2L ZOAB onderlaag":[10.3,9.3,8.3,7.1,5.8],
"2L ZOAB onderlaag, minimaal 30% PR":[8.7,8.4,7.8,6.7,5.5]},
  a4c4:{
"AC surf":1.34,"AC surf, minimaal 30% PR":1.34,"AC surf met gemodificeerd bitumen":1.34,
"AC surf, minimaal 30% PR met gemodificeerd bitumen":1.34,"AC surf rood (met penbitumen)":1.38,
"AC bin/base, minimaal 50% PR":1.32,"AC bin/base, minimaal 50% PR met gemodificeerd bitumen":1.32,
"AC bin/base minimaal 60% PR":1.32,"SMA 8-11":1.38,"SMA 8-11 met gemodificeerd bitumen":1.38,
"SMA 8-11 minimaal 30% PR":1.38,"SMA 5":1.40,"SMA geluidsreducerende deklaag (op basis van 8G+)":1.40,
"SMA rood":1.38,"ZOAB regulier":1.96,"ZOAB regulier+ / DZOAB":1.80,"DZOAB, minimaal 30% PR":1.80,
"2L ZOAB toplaag met gemodificeerd bitumen":1.80,"2L ZOAB onderlaag":1.80,"2L ZOAB onderlaag, minimaal 30% PR":1.80}
};

/* === Eisentabel renderen + highlight === */
const tbl=$("#eisen-table");
const hdr=el("tr",{class:"bg-gray-100"},[
 el("th",{class:"px-3 py-2 text-left"},"Asfaltsoort"),
 ...MKI_EISEN.jaar.map(y=>el("th",{class:"px-3 py-2 text-left jaarcol","data-jaar":y},"Plafond "+y)),
 el("th",{class:"px-3 py-2 text-left"},"A4-C4")
]);
tbl.appendChild(hdr);
for(const m in MKI_EISEN.plafonds){
 const r=el("tr",{},[el("td",{class:"border-t px-3 py-1"},m)]);
 MKI_EISEN.plafonds[m].forEach((v,i)=>r.appendChild(el("td",{class:"border-t px-3 py-1 jaarcol","data-jaar":MKI_EISEN.jaar[i]},fmtNL(v))));
 r.appendChild(el("td",{class:"border-t px-3 py-1"},fmtNL(MKI_EISEN.a4c4[m])));
 tbl.appendChild(r);
}
$("#year-target").addEventListener("change",highlightCol);
function highlightCol(){
 const jaar=$("#year-target").value;
 document.querySelectorAll(".jaarcol").forEach(td=>td.classList.remove("highlight-col"));
 document.querySelectorAll(`.jaarcol[data-jaar='${jaar}']`).forEach(td=>td.classList.add("highlight-col"));
}
highlightCol();

/* ===== Supabase ===== */
const sb=window.supabase.createClient(
  "https://fblenxtccwpsjwrkirtc.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZibGVueHRjY3dwc2p3cmtpcnRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMDYzNDcsImV4cCI6MjA3Nzc4MjM0N30.gn7ytE27VNTsA2-AtJUAgyuhJnP2M9PzNvetRL-gbcI"
);

/* ===== PDF helpers & parser ===== */
function parseNumEUexp(s){
  if(!s) return NaN;
  let str=String(s).trim().replace(/\u202F/g,'').replace(/\s+/g,' ');
  if (str.includes(',') && /[Ee][+\-]?\d+$/.test(str)) str=str.replace(',', '.');
  else if (str.includes(',') && !str.includes('.')) str=str.replace(',', '.');
  else if (str.includes(',') && str.includes('.')) { const parts=str.split(','); str=parts[0].replace(/\./g,'')+'.'+parts.slice(1).join(''); }
  str=str.replace(/[^0-9eE\+\-\.]/g,'');
  const n=Number(str);
  return Number.isFinite(n)?n:NaN;
}
async function waitPdf(){while(!window.pdfjsLib){await new Promise(r=>setTimeout(r,100));}}
async function pdfToText(file){
  await waitPdf();
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text='';
  for(let p=1;p<=Math.min(8,pdf.numPages);p++){
    const page=await pdf.getPage(p);
    const c=await page.getTextContent();
    text += '\n' + c.items.map(it=>it.str).join(' ');
  }
  return text;
}
function pick(re,txt){const m=txt.match(re);return m?m[1].trim():'';}
function extractFromMKIResults(txt){
  const mm = txt.match(/Resultaten[\s\S]{0,400}MKI\s+Euro([\s\S]{0,260})/i);
  if(!mm) return null;
  const after=mm[1].replace(/\s+/g,' ').trim();
  const nums=[...after.matchAll(/([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/g)].map(m=>m[1]);
  if(nums.length<5) return null; // verwacht: ... A1-A3 (index 3), D (index 4)
  const a13=parseNumEUexp(nums[3]);
  const d  =parseNumEUexp(nums[4]);
  if(!isNaN(a13) || !isNaN(d)) return {a13,d};
  return null;
}
function cleanPCR(txt){
  if(/NL-?PCR\s*Asfalt\s*2\.0/i.test(txt)) return "NL-PCR Asfalt 2.0";
  if(/PCR[^0-9]*2\.0/i.test(txt)) return "PCR 2.0";
  return "NL-PCR Asfalt 2.0";
}
async function parseEpd(file){
  const text = await pdfToText(file);
  const product = pick(/Product:\s*([^\n]+?)\s+(?:Eenheid|Producer|Producent)/i, text) || file.name.replace(/\.pdf$/i,'');
  const pcrRaw  = pick(/PCR[:\s]+([^\n]+)$/im, text) || "";
  const pcr     = cleanPCR(pcrRaw || text);
  const pubDate = pick(/Datum(?:\s+van)?\s+publicatie[:\s]+([0-9]{2}-[0-9]{2}-[0-9]{4})/i, text) || '';

  let a13, d;
  const res = extractFromMKIResults(text);
  if(res){ a13=res.a13; d=res.d; }

  if(isNaN(a13)){
    const m = text.match(/\bA1-?A3\b[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
    if(m) a13 = parseNumEUexp(m[1]);
  }
  if(isNaN(d)){
    const m = text.match(/(?:^|\s|\b)D(?:\s|:)[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
    if(m) d = parseNumEUexp(m[1]);
    else {
      const blk = text.match(/Environmental\s+Costs?\s+Indicator[\s\S]{0,600}/i);
      if(blk){
        const md=blk[0].match(/(?:^|\s|\b)D(?:\s|:)[^\d\-]*([\-]?\d[\d\.\,]*(?:[Ee][\+\-]?\d+)?)/i);
        if(md) d=parseNumEUexp(md[1]);
      }
    }
  }
  return { product, pcr, pubDate, mkiA1A3:a13, mkiD:d, text };
}

/* ===== Asfaltsoort-suggestie (uitgebreid) ===== */
function has(t, ...patterns){return patterns.some(p=>p.test(t));}
function detectPR(t){
  if(/\b6?0\s*%?\s*PR\b/i.test(t) || /\bPR\s*60\b/i.test(t)) return 60;
  if(/\b5?0\s*%?\s*PR\b/i.test(t) || /\bPR\s*50\b/i.test(t)) return 50;
  if(/\b3?0\s*%?\s*PR\b/i.test(t) || /\bPR\s*30\b/i.test(t)) return 30;
  return null;
}
function detectGemod(t){ return /gemod|pmb|polymeer/i.test(t); }
function suggestMixFromText(txt){
  const t=(txt||'').toLowerCase();

  if(has(t,/8g\+?/,/geluidsreducer/)) return "SMA geluidsreducerende deklaag (op basis van 8G+)";
  if(has(t,/sma/)){
    if(has(t,/rood|clobred|red/)) return "SMA rood";
    if(has(t,/sma[-\s_]?5\b/)) return "SMA 5";
    if(has(t,/gemod|pmb|polymeer/)) return "SMA 8-11 met gemodificeerd bitumen";
    const pr=detectPR(t);
    if(pr===30) return "SMA 8-11 minimaal 30% PR";
    if(has(t,/sma[-\s_]?nl\s*8b|sma\s*8[-\s]?11|sma\s*8b/)) return "SMA 8-11";
    return "SMA 8-11";
  }

  if(has(t,/2l.*zoab.*top/)) return "2L ZOAB toplaag met gemodificeerd bitumen";
  if(has(t,/2l.*zoab.*onderlaag.*30/)) return "2L ZOAB onderlaag, minimaal 30% PR";
  if(has(t,/2l.*zoab.*onderlaag/)) return "2L ZOAB onderlaag";
  if(has(t,/dzoab|regulier\+|zoab\s*regulier\+/)) return "ZOAB regulier+ / DZOAB";
  if(has(t,/zoab/)) return "ZOAB regulier";

  if(has(t,/ac[^a-z]?(\s|_)*11[^a-z]?(\s|_)*surf|ac[^a-z]?(\s|_)*8[^a-z]?(\s|_)*surf|ac\s*surf/)){
    const gm=detectGemod(t), pr=detectPR(t);
    if(has(t,/rood|clobred|red/)) return "AC surf rood";
    if(gm && pr===30) return "AC surf, minimaal 30% PR met gemodificeerd bitumen";
    if(gm) return "AC surf met gemodificeerd bitumen";
    if(pr===30) return "AC surf, minimaal 30% PR";
    return "AC surf";
  }

  if(has(t,/(ac|asfaltbeton).*(bin|base|binbase)/)){
    const gm=detectGemod(t), pr=detectPR(t);
    if(pr===60) return "AC bin/base minimaal 60% PR";
    if(pr===50 && gm) return "AC bin/base, minimaal 50% PR met gemodificeerd bitumen";
    if(pr===50) return "AC bin/base, minimaal 50% PR";
    if(gm) return "AC bin/base, minimaal 50% PR met gemodificeerd bitumen";
    return "AC bin/base, minimaal 50% PR";
  }

  if(has(t,/clobred|red/)) return "AC surf rood";

  return "";
}

/* ===== Precisie: invoer normaliseren (komma/punt) zonder afronden ===== */
function parseInputPrecise(el){
  let s = (el.value ?? "").trim();
  if(!s) return NaN;
  s = s.replace(/\u202F/g,'').replace(/\s+/g,' ');
  // vervang enkele komma door punt (ook bij E-notatie)
  if (s.includes(',') && /[Ee][+\-]?\d+$/.test(s)) s = s.replace(',', '.');
  else if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
  else if (s.includes(',') && s.includes('.')) { const parts=s.split(','); s=parts[0].replace(/\./g,'')+'.'+parts.slice(1).join(''); }
  s = s.replace(/[^0-9eE\+\-\.]/g,'');
  const n = Number(s);
  return Number.isFinite(n)?n:NaN;
}

/* ===== App ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  const state={ epds:[], runId:null, clientSession:crypto.randomUUID() };
  const epdIn=$("#epd-files"), list=$("#epd-list"), runBtn=$("#run-checks"), csvBtn=$("#export-csv"), results=$("#results"), yearSel=$("#year-target");

  ["dragenter","dragover"].forEach(ev=>$("#epd-drop").addEventListener(ev,e=>{e.preventDefault();e.currentTarget.classList.add("bg-green-50");}));
  ["dragleave","drop","dragend"].forEach(ev=>$("#epd-drop").addEventListener(ev,e=>{e.preventDefault();e.currentTarget.classList.remove("bg-green-50");}));

  epdIn.addEventListener("change",()=>{const files=[...epdIn.files]; if(files.length) handleFiles(files); epdIn.value='';});
  $("#epd-drop").addEventListener("drop",e=>{const files=[...(e.dataTransfer?.files||[])].filter(f=>/\.pdf$/i.test(f.name)); if(files.length) handleFiles(files);});

  async function handleFiles(files){
    if(!state.runId){
      try{
        const { data, error } = await sb.from("epd_runs").insert({
          client_session:state.clientSession, pcr_target:"NL-PCR Asfalt 2.0", year_target:yearSel.value
        }).select("id").single();
        if(error) throw error;
        state.runId=data.id;
      }catch(err){
        toast("Kon database-run niet aanmaken; doorgaan zonder opslag.", false);
      }
    }
    for(const f of files){ await addEpdCard(f); }
  }

  function makeCard(file){
    const card=el("div",{class:"border rounded-xl p-4 bg-white"});
    const head=el("div",{class:"flex justify-between items-center mb-2"},[
      el("div",{class:"font-medium"},file.name),
      el("div",{class:"badge badge-info"},"lezen…")
    ]);
    const meta=el("div",{class:"text-sm text-gray-700 mb-2"},'—');

    const mixSel=el("select",{class:"w-full border rounded-xl px-3 py-2 mb-2"},
      [el("option",{value:""},'— kies asfaltsoort —')].concat(
        Object.keys(MKI_EISEN.plafonds).map(m=>el("option",{value:m},m))
      )
    );

    const a13Input=el("input",{type:"number",step:"any",class:"border rounded-xl px-3 py-2 w-full",id:"a13"});
    const dInput=el("input",{type:"number",step:"any",class:"border rounded-xl px-3 py-2 w-full",id:"md"});
    // live normalisatie van komma → punt (zonder afronden)
    [a13Input,dInput].forEach(inp=>{
      inp.addEventListener('input',()=>{ 
        const cur = inp.value;
        if (/,/.test(cur)) inp.value = cur.replace(',', '.');
      });
    });

    const inputs=el("div",{class:"grid grid-cols-2 gap-3 mb-2"},[
      el("div",{},[el("label",{class:"text-sm"},"MKI A1-A3"), a13Input]),
      el("div",{},[el("label",{class:"text-sm"},"MKI D"), dInput])
    ]);

    card.append(head,meta,mixSel,inputs);
    list.appendChild(card);
    return {card,head,meta,mixSel,a13Input,dInput};
  }

  async function addEpdCard(file){
    const ui=makeCard(file);

    // 1) Parse PDF
    let parsed=null;
    try{
      await waitPdf();
      parsed = await parseEpd(file);
      ui.meta.textContent = `PCR: ${parsed.pcr} · Publicatie: ${parsed.pubDate||'onbekend'}`;
      if(!isNaN(parsed.mkiA1A3)) ui.a13Input.value = parsed.mkiA1A3;
      if(!isNaN(parsed.mkiD))    ui.dInput.value  = parsed.mkiD;

      const hint = suggestMixFromText(parsed.text);
      if(hint) ui.mixSel.value = hint;

      ui.head.lastChild.textContent='gereed';
      ui.head.lastChild.className='badge badge-pass';
    }catch(err){
      ui.meta.textContent = "Fout bij lezen PDF";
      ui.head.lastChild.className = 'badge badge-fail';
    }

    // 2) DB-log (apart)
    try{
      if(state.runId){
        const { data, error } = await sb.from("epd_files").insert({
          run_id: state.runId, file_name: file.name, file_path: "local",
          product: parsed?.product||file.name, pcr_epd: parsed?.pcr||"", pub_date: parsed?.pubDate||""
        }).select("id").single();
        if(error) throw error;
        state.epds.push({
          file, fileId:data.id, parsed,
          get mix(){ return ui.mixSel.value; },
          get a13(){ return parseInputPrecise(ui.a13Input); },
          get d(){ return parseInputPrecise(ui.dInput); }
        });
      }else{
        state.epds.push({
          file, fileId:null, parsed,
          get mix(){ return ui.mixSel.value; },
          get a13(){ return parseInputPrecise(ui.a13Input); },
          get d(){ return parseInputPrecise(ui.dInput); }
        });
      }
    }catch(err){
      toast("Opslaan in database mislukt; resultaten worden wel berekend.", false);
      state.epds.push({
        file, fileId:null, parsed,
        get mix(){ return ui.mixSel.value; },
        get a13(){ return parseInputPrecise(ui.a13Input); },
        get d(){ return parseInputPrecise(ui.dInput); }
      });
    }

    runBtn.disabled=true;
    if(state.epds.length) runBtn.disabled=false;
  }

  runBtn.addEventListener("click", async ()=>{
    const jaar=parseInt(yearSel.value,10), jIdx=MKI_EISEN.jaar.indexOf(jaar);
    results.innerHTML=''; const rows=[];

    for(const epd of state.epds){
      const mix = epd.mix;
      if(!mix){ continue; }

      // >>> Volledige precisie in berekening <<<
      const a1 = epd.a13;                // geen afronding
      const a4 = MKI_EISEN.a4c4[mix] ?? NaN;
      const d  = epd.d;                  // geen afronding
      const plaf = MKI_EISEN.plafonds[mix]?.[jIdx];

      const tot = (a1||0)+(a4||0)+(d||0);     // rekensom op volledige precisie
      const pass = (!isNaN(tot) && !isNaN(plaf) && tot<=plaf);

      const card=el("div",{class:`border rounded-xl p-4 mb-4 ${pass?'bg-green-50':'bg-red-50'}`},[
        el("div",{class:"flex justify-between"},[
          el("div",{class:"font-medium"},epd.file.name),
          el("div",{class:`badge ${pass?'badge-pass':'badge-fail'}`}, pass?'PASS':'FAIL')
        ]),
        el("table",{class:"mt-2 text-sm mono"},[
          el("tr",{},[el("td",{class:"pr-4"},'Asfaltsoort'), el("td",{}, mix)]),
          el("tr",{},[el("td",{class:"pr-4"},'Jaar'),        el("td",{}, jaar)]),
          el("tr",{},[el("td",{class:"pr-4"},'MKI A1-A3'),   el("td",{}, fmtNL(a1))]),
          el("tr",{},[el("td",{class:"pr-4"},'MKI A4-C4'),   el("td",{}, fmtNL(a4))]),
          el("tr",{},[el("td",{class:"pr-4"},'MKI D'),       el("td",{}, fmtNL(d))]),
          el("tr",{},[el("td",{class:"pr-4 font-semibold"},'MKI A-D totaal'), el("td",{class:"font-semibold"}, fmtNL(tot))]),
          el("tr",{},[el("td",{class:"pr-4"},'Plafondwaarde'), el("td",{}, fmtNL(plaf))]),
          el("tr",{},[el("td",{class:"pr-4"},'Marginale ruimte'), el("td",{}, fmtNL(plaf - tot))]),
        ])
      ]);
      results.appendChild(card);

      rows.push({
        "Bestand": epd.file.name,
        "Asfaltsoort": mix,
        "Jaar": jaar,
        "PCR (EPD)": (epd.parsed?.pcr || "NL-PCR Asfalt 2.0"),
        "MKI A1-A3": fmtNL(a1),
        "MKI A4-C4": fmtNL(a4),
        "MKI D": fmtNL(d),
        "MKI A-D totaal": fmtNL(tot),
        "Plafondwaarde": fmtNL(plaf),
        "Marginale ruimte": fmtNL(plaf - tot),
        "Voldoet aan eis": pass ? "Ja" : "Nee",
        "Eisenset": "Uniforme MKI-plafondwaarden 2025 (PCR 2.0)",
        "Eis-jaar": jaar
      });

      try{
        if(state.runId){
          await sb.from("epd_results").insert({
            run_id: state.runId, file_id: epd.fileId, mix, year: jaar,
            mki_a1a3:a1, mki_a4c4:a4, mki_d:d, mki_total_ad:tot,
            plafond:plaf, pass
          });
        }
      }catch{}
    }

    // CSV export (UTF-8 BOM + ; + ASCII headers)
    if(rows.length){
      const headers=Object.keys(rows[0]);
      const csvLines=[headers.join(";")].concat(
        rows.map(r=>headers.map(h=>String(r[h]??"")).join(";"))
      );
      const BOM="\uFEFF";
      const blob=new Blob([BOM+csvLines.join("\n")],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      csvBtn.disabled=false;
      csvBtn.onclick=()=>{const a=document.createElement("a");a.href=url;a.download="mki-resultaten.csv";a.click();};
    }else{
      csvBtn.disabled=true;
    }
    toast("Controle uitgevoerd", true);
  });
});
</script>

<!-- pdf.js loader (ESM) -->
<script type="module">
import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.mjs";
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.mjs";
window.pdfjsLib=pdfjsLib;
</script>
</body>
</html>
